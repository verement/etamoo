<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/MOO/Task.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE OverloadedStrings, ExistentialQuantification #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>MOO</span><span class='hs-varop'>.</span><span class='hs-conid'>Task</span> <span class='hs-layout'>(</span>
<a name="line-5"></a>  <span class='hs-comment'>-- * Monad Interface</span>
<a name="line-6"></a>    <span class='hs-conid'>MOO</span>
<a name="line-7"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Environment</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-8"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>initEnvironment</span>
<a name="line-9"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>liftSTM</span>
<a name="line-10"></a>
<a name="line-11"></a>  <span class='hs-comment'>-- * World Interface</span>
<a name="line-12"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>World</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-13"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>newWorld</span>
<a name="line-14"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getWorld</span>
<a name="line-15"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getWorld'</span>
<a name="line-16"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>putWorld</span>
<a name="line-17"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>modifyWorld</span>
<a name="line-18"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getDatabase</span>
<a name="line-19"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>putDatabase</span>
<a name="line-20"></a>
<a name="line-21"></a>  <span class='hs-comment'>-- * Task Interface</span>
<a name="line-22"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Task</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-23"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>TaskStatus</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-24"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Wake</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-25"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>TaskState</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-26"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>CallStack</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-27"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>DelayedIO</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-28"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>TaskDisposition</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-29"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Resume</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-30"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Resource</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-31"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>initState</span>
<a name="line-32"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>newState</span>
<a name="line-33"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>initTask</span>
<a name="line-34"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>newTaskId</span>
<a name="line-35"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>newTask</span>
<a name="line-36"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskOwner</span>
<a name="line-37"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isQueued</span>
<a name="line-38"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>queuedTasks</span>
<a name="line-39"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>stepTask</span>
<a name="line-40"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>runTask</span>
<a name="line-41"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>forkTask</span>
<a name="line-42"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>interrupt</span>
<a name="line-43"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>requestIO</span>
<a name="line-44"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>delayIO</span>
<a name="line-45"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>unsafeIOtoMOO</span>
<a name="line-46"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getTask</span>
<a name="line-47"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>putTask</span>
<a name="line-48"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>purgeTask</span>
<a name="line-49"></a>
<a name="line-50"></a>  <span class='hs-comment'>-- * Object Interface</span>
<a name="line-51"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getPlayer</span>
<a name="line-52"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getObject</span>
<a name="line-53"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getObjectName</span>
<a name="line-54"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getProperty</span>
<a name="line-55"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>modifyProperty</span>
<a name="line-56"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>modifyVerb</span>
<a name="line-57"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>readProperty</span>
<a name="line-58"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>writeProperty</span>
<a name="line-59"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>setBuiltinProperty</span>
<a name="line-60"></a>
<a name="line-61"></a>  <span class='hs-comment'>-- * Verb Execution Interface</span>
<a name="line-62"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>getVerb</span>
<a name="line-63"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>findVerb</span>
<a name="line-64"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>callSystemVerb</span>
<a name="line-65"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>callSystemVerb'</span>
<a name="line-66"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>callCommandVerb</span>
<a name="line-67"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>callVerb</span>
<a name="line-68"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>callFromFunc</span>
<a name="line-69"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>evalFromFunc</span>
<a name="line-70"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>runVerb</span>
<a name="line-71"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>runTick</span>
<a name="line-72"></a>
<a name="line-73"></a>  <span class='hs-comment'>-- * Verb Frame Interface</span>
<a name="line-74"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>StackFrame</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-75"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Continuation</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-76"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>initFrame</span>
<a name="line-77"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>formatFrames</span>
<a name="line-78"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>pushFrame</span>
<a name="line-79"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>popFrame</span>
<a name="line-80"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>activeFrame</span>
<a name="line-81"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>frame</span>
<a name="line-82"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>caller</span>
<a name="line-83"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>modifyFrame</span>
<a name="line-84"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>setLineNumber</span>
<a name="line-85"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>mkVariables</span>
<a name="line-86"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>formatTraceback</span>
<a name="line-87"></a>
<a name="line-88"></a>  <span class='hs-comment'>-- * Loop and Try/Finally Control Functions</span>
<a name="line-89"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>pushTryFinallyContext</span>
<a name="line-90"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>pushLoopContext</span>
<a name="line-91"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>setLoopContinue</span>
<a name="line-92"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>popContext</span>
<a name="line-93"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>breakLoop</span>
<a name="line-94"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>continueLoop</span>
<a name="line-95"></a>
<a name="line-96"></a>  <span class='hs-comment'>-- * Exception Handling</span>
<a name="line-97"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Exception</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-98"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Code</span>
<a name="line-99"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Message</span>
<a name="line-100"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>raiseException</span>
<a name="line-101"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>raise</span>
<a name="line-102"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>catchException</span>
<a name="line-103"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>passException</span>
<a name="line-104"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>handleDebug</span>
<a name="line-105"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>timeoutException</span>
<a name="line-106"></a>
<a name="line-107"></a>  <span class='hs-comment'>-- * Utility Check Functions</span>
<a name="line-108"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isWizard</span>
<a name="line-109"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>checkFloat</span>
<a name="line-110"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>checkProgrammer</span>
<a name="line-111"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>checkWizard</span>
<a name="line-112"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>checkPermission</span>
<a name="line-113"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>checkValid</span>
<a name="line-114"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>checkFertile</span>
<a name="line-115"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>checkRecurrence</span>
<a name="line-116"></a>
<a name="line-117"></a>  <span class='hs-comment'>-- * Miscellaneous</span>
<a name="line-118"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>binaryString</span>
<a name="line-119"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>random</span>
<a name="line-120"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>newRandomGen</span>
<a name="line-121"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>delay</span>
<a name="line-122"></a>
<a name="line-123"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>shutdown</span>
<a name="line-124"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>notyet</span>
<a name="line-125"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-126"></a>
<a name="line-127"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Arrow</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varop'>&amp;&amp;&amp;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-128"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span><span class='hs-layout'>,</span> <span class='hs-conid'>ThreadId</span><span class='hs-layout'>,</span> <span class='hs-varid'>myThreadId</span><span class='hs-layout'>,</span> <span class='hs-varid'>forkIO</span><span class='hs-layout'>,</span> <span class='hs-varid'>threadDelay</span><span class='hs-layout'>,</span>
<a name="line-129"></a>                           <span class='hs-varid'>newEmptyMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>putMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>tryPutMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>takeMVar</span><span class='hs-layout'>)</span>
<a name="line-130"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span><span class='hs-varop'>.</span><span class='hs-conid'>STM</span> <span class='hs-layout'>(</span><span class='hs-conid'>STM</span><span class='hs-layout'>,</span> <span class='hs-conid'>TVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>atomically</span><span class='hs-layout'>,</span> <span class='hs-varid'>retry</span><span class='hs-layout'>,</span> <span class='hs-varid'>throwSTM</span><span class='hs-layout'>,</span>
<a name="line-131"></a>                               <span class='hs-varid'>newEmptyTMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>putTMVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>takeTMVar</span><span class='hs-layout'>,</span>
<a name="line-132"></a>                               <span class='hs-varid'>newTVarIO</span><span class='hs-layout'>,</span> <span class='hs-varid'>readTVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>writeTVar</span><span class='hs-layout'>,</span> <span class='hs-varid'>modifyTVar</span><span class='hs-layout'>)</span>
<a name="line-133"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span> <span class='hs-layout'>(</span><span class='hs-conid'>SomeException</span><span class='hs-layout'>,</span> <span class='hs-varid'>catch</span><span class='hs-layout'>)</span>
<a name="line-134"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span> <span class='hs-layout'>(</span><span class='hs-varid'>when</span><span class='hs-layout'>,</span> <span class='hs-varid'>unless</span><span class='hs-layout'>,</span> <span class='hs-varid'>join</span><span class='hs-layout'>,</span> <span class='hs-varid'>liftM</span><span class='hs-layout'>,</span> <span class='hs-varid'>void</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&gt;=&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-135"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Cont</span> <span class='hs-layout'>(</span><span class='hs-conid'>ContT</span><span class='hs-layout'>,</span> <span class='hs-varid'>runContT</span><span class='hs-layout'>,</span> <span class='hs-varid'>callCC</span><span class='hs-layout'>)</span>
<a name="line-136"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Reader</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReaderT</span><span class='hs-layout'>,</span> <span class='hs-varid'>runReaderT</span><span class='hs-layout'>,</span> <span class='hs-varid'>local</span><span class='hs-layout'>,</span> <span class='hs-varid'>asks</span><span class='hs-layout'>)</span>
<a name="line-137"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>State</span><span class='hs-varop'>.</span><span class='hs-conid'>Strict</span> <span class='hs-layout'>(</span><span class='hs-conid'>StateT</span><span class='hs-layout'>,</span> <span class='hs-varid'>runStateT</span><span class='hs-layout'>,</span> <span class='hs-varid'>get</span><span class='hs-layout'>,</span> <span class='hs-varid'>gets</span><span class='hs-layout'>,</span> <span class='hs-varid'>modify</span><span class='hs-layout'>)</span>
<a name="line-138"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Trans</span><span class='hs-varop'>.</span><span class='hs-conid'>Class</span> <span class='hs-layout'>(</span><span class='hs-varid'>lift</span><span class='hs-layout'>)</span>
<a name="line-139"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Writer</span> <span class='hs-layout'>(</span><span class='hs-varid'>execWriter</span><span class='hs-layout'>,</span> <span class='hs-varid'>tell</span><span class='hs-layout'>)</span>
<a name="line-140"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-layout'>(</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span>
<a name="line-141"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Int</span> <span class='hs-layout'>(</span><span class='hs-conid'>Int32</span><span class='hs-layout'>)</span>
<a name="line-142"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span> <span class='hs-layout'>(</span><span class='hs-varid'>find</span><span class='hs-layout'>)</span>
<a name="line-143"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-layout'>)</span>
<a name="line-144"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>isNothing</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromMaybe</span><span class='hs-layout'>,</span> <span class='hs-varid'>fromJust</span><span class='hs-layout'>)</span>
<a name="line-145"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Monoid</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monoid</span><span class='hs-layout'>(</span><span class='hs-varid'>mempty</span><span class='hs-layout'>,</span> <span class='hs-varid'>mappend</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varop'>&lt;&gt;</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-146"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-layout'>(</span><span class='hs-conid'>Text</span><span class='hs-layout'>)</span>
<a name="line-147"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Time</span> <span class='hs-layout'>(</span><span class='hs-conid'>UTCTime</span><span class='hs-layout'>,</span> <span class='hs-varid'>getCurrentTime</span><span class='hs-layout'>,</span> <span class='hs-varid'>addUTCTime</span><span class='hs-layout'>)</span>
<a name="line-148"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Time</span><span class='hs-varop'>.</span><span class='hs-conid'>Clock</span><span class='hs-varop'>.</span><span class='hs-conid'>POSIX</span> <span class='hs-layout'>(</span><span class='hs-varid'>posixSecondsToUTCTime</span><span class='hs-layout'>)</span>
<a name="line-149"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Unsafe</span> <span class='hs-layout'>(</span><span class='hs-varid'>unsafePerformIO</span><span class='hs-layout'>)</span>
<a name="line-150"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Posix</span> <span class='hs-layout'>(</span><span class='hs-varid'>nanosleep</span><span class='hs-layout'>)</span>
<a name="line-151"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Random</span> <span class='hs-layout'>(</span><span class='hs-conid'>Random</span><span class='hs-layout'>,</span> <span class='hs-conid'>StdGen</span><span class='hs-layout'>,</span> <span class='hs-varid'>newStdGen</span><span class='hs-layout'>,</span> <span class='hs-varid'>mkStdGen</span><span class='hs-layout'>,</span> <span class='hs-varid'>split</span><span class='hs-layout'>,</span>
<a name="line-152"></a>                      <span class='hs-varid'>randomR</span><span class='hs-layout'>,</span> <span class='hs-varid'>randomRs</span><span class='hs-layout'>)</span>
<a name="line-153"></a>
<a name="line-154"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>M</span>
<a name="line-155"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Text</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>T</span>
<a name="line-156"></a>
<a name="line-157"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MOO</span><span class='hs-varop'>.</span><span class='hs-conid'>Command</span>
<a name="line-158"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>MOO</span><span class='hs-varop'>.</span><span class='hs-conid'>Database</span>
<a name="line-159"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>MOO</span><span class='hs-varop'>.</span><span class='hs-conid'>Network</span>
<a name="line-160"></a><span class='hs-keyword'>import</span> <span class='hs-comment'>{-# SOURCE #-}</span> <span class='hs-conid'>MOO</span><span class='hs-varop'>.</span><span class='hs-conid'>Connection</span>
<a name="line-161"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MOO</span><span class='hs-varop'>.</span><span class='hs-conid'>Object</span>
<a name="line-162"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MOO</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-163"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>MOO</span><span class='hs-varop'>.</span><span class='hs-conid'>Verb</span>
<a name="line-164"></a>
<a name="line-165"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>MOO</span><span class='hs-varop'>.</span><span class='hs-conid'>String</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Str</span>
<a name="line-166"></a>
<a name="line-167"></a><a name="MOO"></a><span class='hs-comment'>-- | This is the basic MOO monad transformer stack. A computation of type</span>
<a name="line-168"></a><a name="MOO"></a><span class='hs-comment'>-- @'MOO' a@ is an 'STM' transaction that returns a value of type @a@ within</span>
<a name="line-169"></a><a name="MOO"></a><span class='hs-comment'>-- an environment that supports state, continuations, and local modification.</span>
<a name="line-170"></a><a name="MOO"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>MOO</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ReaderT</span> <span class='hs-conid'>Environment</span>
<a name="line-171"></a>           <span class='hs-layout'>(</span><span class='hs-conid'>ContT</span> <span class='hs-conid'>TaskDisposition</span>
<a name="line-172"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>StateT</span> <span class='hs-conid'>TaskState</span> <span class='hs-conid'>STM</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-173"></a>
<a name="line-174"></a><a name="liftSTM"></a><span class='hs-comment'>-- | Lift an 'STM' transaction into the 'MOO' monad.</span>
<a name="line-175"></a><span class='hs-definition'>liftSTM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>STM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-176"></a><span class='hs-definition'>liftSTM</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lift</span> <span class='hs-varop'>.</span> <span class='hs-varid'>lift</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="World"></a><span class='hs-comment'>-- | The known universe, as far as the MOO server is concerned</span>
<a name="line-179"></a><a name="World"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>World</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>World</span> <span class='hs-layout'>{</span>
<a name="line-180"></a>    <span class='hs-varid'>database</span>           <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Database</span>              <span class='hs-comment'>-- ^ The database of objects</span>
<a name="line-181"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tasks</span>              <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>TaskId</span> <span class='hs-conid'>Task</span>       <span class='hs-comment'>-- ^ Queued and running tasks</span>
<a name="line-182"></a>
<a name="line-183"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>listeners</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Point</span> <span class='hs-conid'>Listener</span>    <span class='hs-comment'>-- ^ Network listening points</span>
<a name="line-184"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>connections</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>ObjId</span> <span class='hs-conid'>Connection</span>  <span class='hs-comment'>-- ^ Network connections</span>
<a name="line-185"></a>
<a name="line-186"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>nextConnectionId</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span>
<a name="line-187"></a>    <span class='hs-comment'>-- ^ The (negative) object number to be assigned to the next inbound or</span>
<a name="line-188"></a>    <span class='hs-comment'>-- outbound connection</span>
<a name="line-189"></a>
<a name="line-190"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>outboundNetwork</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-191"></a>    <span class='hs-comment'>-- ^ Is @open_network_connection()@ enabled?</span>
<a name="line-192"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>bindAddress</span>        <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>HostName</span>
<a name="line-193"></a>    <span class='hs-comment'>-- ^ Interface address to bind to for incoming connections</span>
<a name="line-194"></a>
<a name="line-195"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>shutdownMessage</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MVar</span> <span class='hs-conid'>Text</span>
<a name="line-196"></a>    <span class='hs-comment'>-- ^ Shutdown signal</span>
<a name="line-197"></a>  <span class='hs-layout'>}</span>
<a name="line-198"></a>
<a name="line-199"></a><a name="initWorld"></a><span class='hs-definition'>initWorld</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>World</span> <span class='hs-layout'>{</span>
<a name="line-200"></a>    <span class='hs-varid'>database</span>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>undefined</span>
<a name="line-201"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>tasks</span>            <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-202"></a>
<a name="line-203"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>listeners</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-204"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>connections</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-205"></a>
<a name="line-206"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>nextConnectionId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>firstConnectionId</span>
<a name="line-207"></a>
<a name="line-208"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>outboundNetwork</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-209"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>bindAddress</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-210"></a>
<a name="line-211"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>shutdownMessage</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>undefined</span>
<a name="line-212"></a>  <span class='hs-layout'>}</span>
<a name="line-213"></a>
<a name="line-214"></a><a name="newWorld"></a><span class='hs-definition'>newWorld</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Database</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TVar</span> <span class='hs-conid'>World</span><span class='hs-layout'>)</span>
<a name="line-215"></a><span class='hs-definition'>newWorld</span> <span class='hs-varid'>db</span> <span class='hs-varid'>outboundNetworkEnabled</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-216"></a>  <span class='hs-varid'>shutdownVar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEmptyMVar</span>
<a name="line-217"></a>
<a name="line-218"></a>  <span class='hs-varid'>world'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTVarIO</span> <span class='hs-varid'>initWorld</span> <span class='hs-layout'>{</span>
<a name="line-219"></a>      <span class='hs-varid'>database</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>db</span>
<a name="line-220"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>outboundNetwork</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>outboundNetworkEnabled</span>
<a name="line-221"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>shutdownMessage</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>shutdownVar</span>
<a name="line-222"></a>    <span class='hs-layout'>}</span>
<a name="line-223"></a>
<a name="line-224"></a>  <span class='hs-varid'>runTask</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>newTask</span> <span class='hs-varid'>world'</span> <span class='hs-varid'>nothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>loadServerOptions</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>zero</span><span class='hs-layout'>)</span>
<a name="line-225"></a>
<a name="line-226"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>world'</span>
<a name="line-227"></a>
<a name="line-228"></a><a name="Task"></a><span class='hs-comment'>-- | A structure representing a queued or running task</span>
<a name="line-229"></a><a name="Task"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Task</span> <span class='hs-layout'>{</span>
<a name="line-230"></a>    <span class='hs-varid'>taskId</span>          <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TaskId</span>
<a name="line-231"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskStatus</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TaskStatus</span>
<a name="line-232"></a>
<a name="line-233"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskThread</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ThreadId</span>
<a name="line-234"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskWorld</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TVar</span> <span class='hs-conid'>World</span>
<a name="line-235"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskPlayer</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span>
<a name="line-236"></a>
<a name="line-237"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskState</span>       <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TaskState</span>
<a name="line-238"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskComputation</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-239"></a>  <span class='hs-layout'>}</span>
<a name="line-240"></a>
<a name="line-241"></a><a name="instance%20Show%20Task"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>Task</span> <span class='hs-keyword'>where</span>
<a name="line-242"></a>  <span class='hs-varid'>show</span> <span class='hs-varid'>task</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"&lt;Task "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskId</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span>
<a name="line-243"></a>              <span class='hs-str'>": "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskStatus</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>"&gt;"</span>
<a name="line-244"></a>
<a name="line-245"></a><a name="initTask"></a><span class='hs-definition'>initTask</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Task</span> <span class='hs-layout'>{</span>
<a name="line-246"></a>    <span class='hs-varid'>taskId</span>          <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-247"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskStatus</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pending</span>
<a name="line-248"></a>
<a name="line-249"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskThread</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>undefined</span>
<a name="line-250"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskWorld</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>undefined</span>
<a name="line-251"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskPlayer</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nothing</span>
<a name="line-252"></a>
<a name="line-253"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskState</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initState</span>
<a name="line-254"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>taskComputation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>zero</span>
<a name="line-255"></a>  <span class='hs-layout'>}</span>
<a name="line-256"></a>
<a name="line-257"></a><a name="instance%20Sizeable%20Task"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Sizeable</span> <span class='hs-conid'>Task</span> <span class='hs-keyword'>where</span>
<a name="line-258"></a>  <span class='hs-varid'>storageBytes</span> <span class='hs-varid'>task</span> <span class='hs-keyglyph'>=</span>
<a name="line-259"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskId</span>     <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-260"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskThread</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-261"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskWorld</span>  <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-262"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskPlayer</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-263"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskStatus</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-264"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskState</span>  <span class='hs-varid'>task</span><span class='hs-layout'>)</span>
<a name="line-265"></a>    <span class='hs-comment'>-- storageBytes (taskComputation task)</span>
<a name="line-266"></a>
<a name="line-267"></a><a name="instance%20Eq%20Task"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Eq</span> <span class='hs-conid'>Task</span> <span class='hs-keyword'>where</span>
<a name="line-268"></a>  <span class='hs-conid'>Task</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>taskId1</span> <span class='hs-layout'>}</span> <span class='hs-varop'>==</span> <span class='hs-conid'>Task</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>taskId2</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-269"></a>    <span class='hs-varid'>taskId1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>taskId2</span>
<a name="line-270"></a>
<a name="line-271"></a><a name="instance%20Ord%20Task"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Ord</span> <span class='hs-conid'>Task</span> <span class='hs-keyword'>where</span>
<a name="line-272"></a>  <span class='hs-conid'>Task</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskState</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>state1</span> <span class='hs-layout'>}</span> <span class='hs-varop'>`compare`</span> <span class='hs-conid'>Task</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskState</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>state2</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-273"></a>    <span class='hs-varid'>startTime</span> <span class='hs-varid'>state1</span> <span class='hs-varop'>`compare`</span> <span class='hs-varid'>startTime</span> <span class='hs-varid'>state2</span>
<a name="line-274"></a>
<a name="line-275"></a><a name="TaskId"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>TaskId</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Int32</span>
<a name="line-276"></a>
<a name="line-277"></a><a name="newTaskId"></a><span class='hs-comment'>-- | Generate a (random) 'TaskId' not currently in use by any existing task.</span>
<a name="line-278"></a><span class='hs-definition'>newTaskId</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>World</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StdGen</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TaskId</span>
<a name="line-279"></a><span class='hs-definition'>newTaskId</span> <span class='hs-varid'>world</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromJust</span> <span class='hs-varop'>.</span> <span class='hs-varid'>find</span> <span class='hs-varid'>unused</span> <span class='hs-varop'>.</span> <span class='hs-varid'>randomRs</span> <span class='hs-layout'>(</span><span class='hs-num'>1</span><span class='hs-layout'>,</span> <span class='hs-varid'>maxBound</span><span class='hs-layout'>)</span>
<a name="line-280"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>unused</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>`</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>notMember</span><span class='hs-varop'>`</span> <span class='hs-varid'>tasks</span> <span class='hs-varid'>world</span><span class='hs-layout'>)</span>
<a name="line-281"></a>
<a name="line-282"></a><a name="newTask"></a><span class='hs-comment'>-- | Create a pending 'Task' for the given computation on behalf of the given</span>
<a name="line-283"></a><span class='hs-comment'>-- player. A new 'TaskId' is reserved for the task and the task is added to</span>
<a name="line-284"></a><span class='hs-comment'>-- the 'World'. (The task will not actually run until passed to 'runTask'.)</span>
<a name="line-285"></a><span class='hs-definition'>newTask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TVar</span> <span class='hs-conid'>World</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Task</span>
<a name="line-286"></a><span class='hs-definition'>newTask</span> <span class='hs-varid'>world'</span> <span class='hs-varid'>player</span> <span class='hs-varid'>comp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-287"></a>  <span class='hs-varid'>gen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newStdGen</span>
<a name="line-288"></a>  <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newState</span>
<a name="line-289"></a>
<a name="line-290"></a>  <span class='hs-varid'>atomically</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-291"></a>    <span class='hs-varid'>world</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTVar</span> <span class='hs-varid'>world'</span>
<a name="line-292"></a>
<a name="line-293"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>taskId</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newTaskId</span> <span class='hs-varid'>world</span> <span class='hs-varid'>gen</span>
<a name="line-294"></a>        <span class='hs-varid'>task</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initTask</span> <span class='hs-layout'>{</span>
<a name="line-295"></a>            <span class='hs-varid'>taskId</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>taskId</span>
<a name="line-296"></a>
<a name="line-297"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>taskWorld</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>world'</span>
<a name="line-298"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>taskPlayer</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>player</span>
<a name="line-299"></a>
<a name="line-300"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>taskState</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>state</span>
<a name="line-301"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>taskComputation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>comp</span>
<a name="line-302"></a>          <span class='hs-layout'>}</span>
<a name="line-303"></a>
<a name="line-304"></a>    <span class='hs-varid'>writeTVar</span> <span class='hs-varid'>world'</span> <span class='hs-varid'>world</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tasks</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>taskId</span> <span class='hs-varid'>task</span> <span class='hs-layout'>(</span><span class='hs-varid'>tasks</span> <span class='hs-varid'>world</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-305"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>task</span>
<a name="line-306"></a>
<a name="line-307"></a><a name="taskOwner"></a><span class='hs-definition'>taskOwner</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ObjId</span>
<a name="line-308"></a><span class='hs-definition'>taskOwner</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>permissions</span> <span class='hs-varop'>.</span> <span class='hs-varid'>activeFrame</span>
<a name="line-309"></a>
<a name="line-310"></a><a name="TaskStatus"></a><span class='hs-comment'>-- | The running state of a task</span>
<a name="line-311"></a><a name="TaskStatus"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TaskStatus</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Pending</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Running</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Forked</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Suspended</span> <span class='hs-conid'>Wake</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Reading</span>
<a name="line-312"></a>                <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-313"></a>
<a name="line-314"></a><a name="isQueued"></a><span class='hs-definition'>isQueued</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TaskStatus</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-315"></a><span class='hs-definition'>isQueued</span> <span class='hs-conid'>Pending</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-316"></a><span class='hs-definition'>isQueued</span> <span class='hs-conid'>Running</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-317"></a><span class='hs-definition'>isQueued</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-318"></a>
<a name="line-319"></a><a name="isRunning"></a><span class='hs-definition'>isRunning</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TaskStatus</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-320"></a><span class='hs-definition'>isRunning</span> <span class='hs-conid'>Running</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-321"></a><span class='hs-definition'>isRunning</span> <span class='hs-keyword'>_</span>       <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-322"></a>
<a name="line-323"></a><a name="queuedTasks"></a><span class='hs-definition'>queuedTasks</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Task</span><span class='hs-keyglyph'>]</span>
<a name="line-324"></a><span class='hs-definition'>queuedTasks</span> <span class='hs-keyglyph'>=</span>
<a name="line-325"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varid'>isQueued</span> <span class='hs-varop'>.</span> <span class='hs-varid'>taskStatus</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>elems</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tasks</span><span class='hs-layout'>)</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>getWorld</span>
<a name="line-326"></a>
<a name="line-327"></a><a name="instance%20Sizeable%20TaskStatus"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Sizeable</span> <span class='hs-conid'>TaskStatus</span> <span class='hs-keyword'>where</span>
<a name="line-328"></a>  <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-conid'>Suspended</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>2</span> <span class='hs-varop'>*</span> <span class='hs-varid'>storageBytes</span> <span class='hs-conid'>()</span>
<a name="line-329"></a>  <span class='hs-varid'>storageBytes</span> <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>=</span>     <span class='hs-varid'>storageBytes</span> <span class='hs-conid'>()</span>
<a name="line-330"></a>
<a name="line-331"></a><a name="Wake"></a><span class='hs-comment'>-- | A function to call in order to wake a suspended task</span>
<a name="line-332"></a><a name="Wake"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>Wake</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Wake</span> <span class='hs-layout'>(</span><span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-333"></a>
<a name="line-334"></a><a name="instance%20Show%20Wake"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>Wake</span> <span class='hs-keyword'>where</span>
<a name="line-335"></a>  <span class='hs-varid'>show</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Wake{..}"</span>
<a name="line-336"></a>
<a name="line-337"></a><a name="TaskDisposition"></a><span class='hs-comment'>-- | The intermediate or final result of a running task</span>
<a name="line-338"></a><a name="TaskDisposition"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TaskDisposition</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Complete</span> <span class='hs-conid'>Value</span>
<a name="line-339"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Suspend</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Integer</span><span class='hs-layout'>)</span>    <span class='hs-layout'>(</span><span class='hs-conid'>Resume</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-340"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Read</span>     <span class='hs-conid'>ObjId</span>             <span class='hs-layout'>(</span><span class='hs-conid'>Resume</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span>
<a name="line-341"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-keyword'>forall</span> <span class='hs-varid'>a</span><span class='hs-varop'>.</span> <span class='hs-conid'>RequestIO</span> <span class='hs-layout'>(</span><span class='hs-conid'>IO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Resume</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-342"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Uncaught</span> <span class='hs-conid'>Exception</span>
<a name="line-343"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Timeout</span>  <span class='hs-conid'>Resource</span>  <span class='hs-conid'>CallStack</span>
<a name="line-344"></a>                     <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Suicide</span>
<a name="line-345"></a>
<a name="line-346"></a><a name="Resume"></a><span class='hs-comment'>-- | A continuation to resume the execution of a task where it left off</span>
<a name="line-347"></a><a name="Resume"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>Resume</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Resume</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span>
<a name="line-348"></a>
<a name="line-349"></a><a name="Resource"></a><span class='hs-comment'>-- | Task resource limits</span>
<a name="line-350"></a><a name="Resource"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Resource</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Ticks</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Seconds</span>
<a name="line-351"></a>
<a name="line-352"></a><a name="showResource"></a><span class='hs-definition'>showResource</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Resource</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span>
<a name="line-353"></a><span class='hs-definition'>showResource</span> <span class='hs-conid'>Ticks</span>   <span class='hs-keyglyph'>=</span> <span class='hs-str'>"ticks"</span>
<a name="line-354"></a><span class='hs-definition'>showResource</span> <span class='hs-conid'>Seconds</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"seconds"</span>
<a name="line-355"></a>
<a name="line-356"></a><a name="timeoutException"></a><span class='hs-definition'>timeoutException</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Resource</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CallStack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Exception</span>
<a name="line-357"></a><span class='hs-definition'>timeoutException</span> <span class='hs-varid'>resource</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>except</span> <span class='hs-layout'>{</span> <span class='hs-varid'>exceptionCallStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stack</span> <span class='hs-layout'>}</span>
<a name="line-358"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>message</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Task ran out of "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>showResource</span> <span class='hs-varid'>resource</span>
<a name="line-359"></a>        <span class='hs-varid'>except</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newException</span> <span class='hs-layout'>(</span><span class='hs-conid'>Err</span> <span class='hs-conid'>E_QUOTA</span><span class='hs-layout'>)</span> <span class='hs-varid'>message</span> <span class='hs-varid'>zero</span>
<a name="line-360"></a>
<a name="line-361"></a><a name="stepTask"></a><span class='hs-definition'>stepTask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TaskDisposition</span><span class='hs-layout'>,</span> <span class='hs-conid'>Task</span><span class='hs-layout'>)</span>
<a name="line-362"></a><span class='hs-definition'>stepTask</span> <span class='hs-varid'>task</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-363"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>env</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initEnvironment</span> <span class='hs-varid'>task</span>
<a name="line-364"></a>      <span class='hs-varid'>comp</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>taskComputation</span> <span class='hs-varid'>task</span>
<a name="line-365"></a>      <span class='hs-varid'>comp'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callCC</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-366"></a>        <span class='hs-conid'>Complete</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>local</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>r</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>r</span> <span class='hs-layout'>{</span> <span class='hs-varid'>interruptHandler</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Interrupt</span> <span class='hs-varid'>k</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>comp</span>
<a name="line-367"></a>      <span class='hs-varid'>state</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>taskState</span> <span class='hs-varid'>task</span>
<a name="line-368"></a>      <span class='hs-varid'>contM</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runReaderT</span> <span class='hs-varid'>comp'</span> <span class='hs-varid'>env</span>
<a name="line-369"></a>      <span class='hs-varid'>stateM</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runContT</span> <span class='hs-varid'>contM</span> <span class='hs-varid'>return</span>
<a name="line-370"></a>      <span class='hs-varid'>stmM</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runStateT</span> <span class='hs-varid'>stateM</span> <span class='hs-varid'>state</span>
<a name="line-371"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>state'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>atomically</span> <span class='hs-varid'>stmM</span>
<a name="line-372"></a>  <span class='hs-varid'>runDelayed</span> <span class='hs-varop'>$</span> <span class='hs-varid'>delayedIO</span> <span class='hs-varid'>state'</span>
<a name="line-373"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>result</span><span class='hs-layout'>,</span> <span class='hs-varid'>task</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskState</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>state'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>delayedIO</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span> <span class='hs-layout'>}</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-374"></a>
<a name="line-375"></a><a name="stepTaskWithIO"></a><span class='hs-definition'>stepTaskWithIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TaskDisposition</span><span class='hs-layout'>,</span> <span class='hs-conid'>Task</span><span class='hs-layout'>)</span>
<a name="line-376"></a><span class='hs-definition'>stepTaskWithIO</span> <span class='hs-varid'>task</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-377"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>disposition</span><span class='hs-layout'>,</span> <span class='hs-varid'>task'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepTask</span> <span class='hs-varid'>task</span>
<a name="line-378"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>disposition</span> <span class='hs-keyword'>of</span>
<a name="line-379"></a>    <span class='hs-conid'>RequestIO</span> <span class='hs-varid'>io</span> <span class='hs-layout'>(</span><span class='hs-conid'>Resume</span> <span class='hs-varid'>resume</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-380"></a>      <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>io</span>
<a name="line-381"></a>      <span class='hs-varid'>stepTaskWithIO</span> <span class='hs-varid'>task'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskComputation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>resume</span> <span class='hs-varid'>result</span> <span class='hs-layout'>}</span>
<a name="line-382"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>disposition</span><span class='hs-layout'>,</span> <span class='hs-varid'>task'</span><span class='hs-layout'>)</span>
<a name="line-383"></a>
<a name="line-384"></a><a name="runTask"></a><span class='hs-comment'>-- | Run a task in a new Haskell thread, returning either the value produced</span>
<a name="line-385"></a><span class='hs-comment'>-- by the task, or 'Nothing' if the task suspends or aborts before producing a</span>
<a name="line-386"></a><span class='hs-comment'>-- value. If the task suspends, it may continue running after this function</span>
<a name="line-387"></a><span class='hs-comment'>-- returns. The task is removed from the task queue after it is finished.</span>
<a name="line-388"></a><span class='hs-definition'>runTask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span>
<a name="line-389"></a><span class='hs-definition'>runTask</span> <span class='hs-varid'>task</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-390"></a>  <span class='hs-varid'>resultMVar</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEmptyMVar</span>
<a name="line-391"></a>
<a name="line-392"></a>  <span class='hs-varid'>forkIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-393"></a>    <span class='hs-varid'>threadId</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>myThreadId</span>
<a name="line-394"></a>    <span class='hs-keyword'>let</span> <span class='hs-varid'>task'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>task</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskThread</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>threadId</span> <span class='hs-layout'>}</span>
<a name="line-395"></a>
<a name="line-396"></a>    <span class='hs-varid'>atomically</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyTVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskWorld</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>world</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-397"></a>      <span class='hs-varid'>world</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tasks</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskId</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span>
<a name="line-398"></a>                      <span class='hs-varid'>task'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskStatus</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Running</span> <span class='hs-layout'>}</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tasks</span> <span class='hs-varid'>world</span> <span class='hs-layout'>}</span>
<a name="line-399"></a>
<a name="line-400"></a>    <span class='hs-varid'>runTask'</span> <span class='hs-varid'>task'</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putMVar</span> <span class='hs-varid'>resultMVar</span>
<a name="line-401"></a>
<a name="line-402"></a>    <span class='hs-varid'>atomically</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyTVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskWorld</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>world</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-403"></a>      <span class='hs-varid'>world</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tasks</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>delete</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskId</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tasks</span> <span class='hs-varid'>world</span> <span class='hs-layout'>}</span>
<a name="line-404"></a>
<a name="line-405"></a>  <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>resultMVar</span>
<a name="line-406"></a>
<a name="line-407"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>noOp</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>const</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-408"></a>
<a name="line-409"></a>        <span class='hs-varid'>runTask'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-410"></a>        <span class='hs-varid'>runTask'</span> <span class='hs-varid'>task</span> <span class='hs-varid'>putResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-411"></a>          <span class='hs-layout'>(</span><span class='hs-varid'>disposition</span><span class='hs-layout'>,</span> <span class='hs-varid'>task'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepTaskWithIO</span> <span class='hs-varid'>task</span>
<a name="line-412"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>disposition</span> <span class='hs-keyword'>of</span>
<a name="line-413"></a>            <span class='hs-conid'>Complete</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>putResult</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>value</span><span class='hs-layout'>)</span>
<a name="line-414"></a>
<a name="line-415"></a>            <span class='hs-conid'>Suspend</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Resume</span> <span class='hs-varid'>resume</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-416"></a>              <span class='hs-varid'>putResult</span> <span class='hs-conid'>Nothing</span>
<a name="line-417"></a>
<a name="line-418"></a>              <span class='hs-comment'>-- restart this task only when there are none other running</span>
<a name="line-419"></a>              <span class='hs-varid'>atomically</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-420"></a>                <span class='hs-varid'>world</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskWorld</span> <span class='hs-varid'>task'</span><span class='hs-layout'>)</span>
<a name="line-421"></a>                <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varid'>isRunning</span> <span class='hs-varop'>.</span> <span class='hs-varid'>taskStatus</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>elems</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tasks</span> <span class='hs-varid'>world</span><span class='hs-layout'>)</span>
<a name="line-422"></a>                  <span class='hs-varid'>retry</span>
<a name="line-423"></a>
<a name="line-424"></a>              <span class='hs-varid'>runTask'</span> <span class='hs-varid'>task'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskComputation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>resume</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span> <span class='hs-varid'>noOp</span>
<a name="line-425"></a>
<a name="line-426"></a>            <span class='hs-conid'>Read</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-str'>"read() not yet implemented"</span>
<a name="line-427"></a>
<a name="line-428"></a>            <span class='hs-conid'>Uncaught</span> <span class='hs-varid'>exception</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Exception</span> <span class='hs-layout'>{</span>
<a name="line-429"></a>                <span class='hs-varid'>exceptionCode</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>code</span>
<a name="line-430"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionMessage</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>message</span>
<a name="line-431"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionValue</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>value</span>
<a name="line-432"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionCallStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-varid'>frames</span>
<a name="line-433"></a>              <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>handleAbortedTask</span> <span class='hs-varid'>task'</span> <span class='hs-varid'>formatted</span> <span class='hs-varid'>putResult</span> <span class='hs-varop'>$</span>
<a name="line-434"></a>                   <span class='hs-varid'>callSystemVerb</span> <span class='hs-str'>"handle_uncaught_error"</span>
<a name="line-435"></a>                   <span class='hs-keyglyph'>[</span><span class='hs-varid'>code</span><span class='hs-layout'>,</span> <span class='hs-conid'>Str</span> <span class='hs-varid'>message</span><span class='hs-layout'>,</span> <span class='hs-varid'>value</span><span class='hs-layout'>,</span> <span class='hs-varid'>traceback</span><span class='hs-layout'>,</span> <span class='hs-varid'>stringList</span> <span class='hs-varid'>formatted</span><span class='hs-keyglyph'>]</span>
<a name="line-436"></a>              <span class='hs-keyword'>where</span> <span class='hs-varid'>traceback</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>formatFrames</span> <span class='hs-conid'>True</span> <span class='hs-varid'>frames</span>
<a name="line-437"></a>                    <span class='hs-varid'>formatted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>formatTraceback</span> <span class='hs-varid'>exception</span>
<a name="line-438"></a>
<a name="line-439"></a>            <span class='hs-conid'>Timeout</span> <span class='hs-varid'>resource</span> <span class='hs-varid'>stack</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Stack</span> <span class='hs-varid'>frames</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-440"></a>              <span class='hs-varid'>handleAbortedTask</span> <span class='hs-varid'>task'</span> <span class='hs-varid'>formatted</span> <span class='hs-varid'>putResult</span> <span class='hs-varop'>$</span>
<a name="line-441"></a>                <span class='hs-varid'>callSystemVerb</span> <span class='hs-str'>"handle_task_timeout"</span>
<a name="line-442"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>Str</span> <span class='hs-varop'>$</span> <span class='hs-varid'>showResource</span> <span class='hs-varid'>resource</span><span class='hs-layout'>,</span> <span class='hs-varid'>traceback</span><span class='hs-layout'>,</span> <span class='hs-varid'>stringList</span> <span class='hs-varid'>formatted</span><span class='hs-keyglyph'>]</span>
<a name="line-443"></a>              <span class='hs-keyword'>where</span> <span class='hs-varid'>traceback</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>formatFrames</span> <span class='hs-conid'>True</span> <span class='hs-varid'>frames</span>
<a name="line-444"></a>                    <span class='hs-varid'>formatted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>formatTraceback</span> <span class='hs-varop'>$</span>
<a name="line-445"></a>                                <span class='hs-varid'>timeoutException</span> <span class='hs-varid'>resource</span> <span class='hs-varid'>stack</span>
<a name="line-446"></a>
<a name="line-447"></a>            <span class='hs-conid'>Suicide</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>putResult</span> <span class='hs-conid'>Nothing</span>
<a name="line-448"></a>
<a name="line-449"></a>        <span class='hs-varid'>handleAbortedTask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StrT</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-450"></a>                             <span class='hs-conid'>MOO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-451"></a>        <span class='hs-varid'>handleAbortedTask</span> <span class='hs-varid'>task</span> <span class='hs-varid'>traceback</span> <span class='hs-varid'>putResult</span> <span class='hs-varid'>call</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-452"></a>          <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newState</span>
<a name="line-453"></a>          <span class='hs-varid'>handleAbortedTask'</span> <span class='hs-varid'>traceback</span> <span class='hs-varid'>task</span> <span class='hs-layout'>{</span>
<a name="line-454"></a>              <span class='hs-varid'>taskState</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>state</span>
<a name="line-455"></a>            <span class='hs-layout'>,</span> <span class='hs-varid'>taskComputation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromMaybe</span> <span class='hs-varid'>zero</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>call</span>
<a name="line-456"></a>            <span class='hs-layout'>}</span>
<a name="line-457"></a>
<a name="line-458"></a>          <span class='hs-keyword'>where</span> <span class='hs-varid'>handleAbortedTask'</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StrT</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-459"></a>                <span class='hs-varid'>handleAbortedTask'</span> <span class='hs-varid'>traceback</span> <span class='hs-varid'>task</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-460"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>disposition</span><span class='hs-layout'>,</span> <span class='hs-varid'>task'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>stepTaskWithIO</span> <span class='hs-varid'>task</span>
<a name="line-461"></a>                  <span class='hs-keyword'>case</span> <span class='hs-varid'>disposition</span> <span class='hs-keyword'>of</span>
<a name="line-462"></a>                    <span class='hs-conid'>Complete</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-463"></a>                      <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>truthOf</span> <span class='hs-varid'>value</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>informPlayer</span> <span class='hs-varid'>traceback</span>
<a name="line-464"></a>                      <span class='hs-varid'>putResult</span> <span class='hs-conid'>Nothing</span>
<a name="line-465"></a>                    <span class='hs-conid'>Suspend</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Resume</span> <span class='hs-varid'>resume</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-466"></a>                      <span class='hs-comment'>-- The aborted task is considered "handled" but continue</span>
<a name="line-467"></a>                      <span class='hs-comment'>-- running the suspended handler (which might abort</span>
<a name="line-468"></a>                      <span class='hs-comment'>-- again!)</span>
<a name="line-469"></a>                      <span class='hs-varid'>putResult</span> <span class='hs-conid'>Nothing</span>
<a name="line-470"></a>                      <span class='hs-varid'>runTask'</span> <span class='hs-varid'>task'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskComputation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>resume</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span> <span class='hs-varid'>noOp</span>
<a name="line-471"></a>                    <span class='hs-conid'>Read</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>error</span> <span class='hs-str'>"read() not yet implemented"</span>
<a name="line-472"></a>                    <span class='hs-conid'>Uncaught</span> <span class='hs-varid'>exception</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-473"></a>                      <span class='hs-varid'>informPlayer</span> <span class='hs-varid'>traceback</span>
<a name="line-474"></a>                      <span class='hs-varid'>informPlayer</span> <span class='hs-varop'>$</span> <span class='hs-varid'>formatTraceback</span> <span class='hs-varid'>exception</span>
<a name="line-475"></a>                      <span class='hs-varid'>putResult</span> <span class='hs-conid'>Nothing</span>
<a name="line-476"></a>                    <span class='hs-conid'>Timeout</span> <span class='hs-varid'>resource</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-477"></a>                      <span class='hs-varid'>informPlayer</span> <span class='hs-varid'>traceback</span>
<a name="line-478"></a>                      <span class='hs-varid'>informPlayer</span> <span class='hs-varop'>$</span> <span class='hs-varid'>formatTraceback</span> <span class='hs-varop'>$</span>
<a name="line-479"></a>                        <span class='hs-varid'>timeoutException</span> <span class='hs-varid'>resource</span> <span class='hs-varid'>stack</span>
<a name="line-480"></a>                      <span class='hs-varid'>putResult</span> <span class='hs-conid'>Nothing</span>
<a name="line-481"></a>                    <span class='hs-conid'>Suicide</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>putResult</span> <span class='hs-conid'>Nothing</span>
<a name="line-482"></a>
<a name="line-483"></a>        <span class='hs-varid'>informPlayer</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StrT</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-484"></a>        <span class='hs-varid'>informPlayer</span> <span class='hs-varid'>lines</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>atomically</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-485"></a>          <span class='hs-varid'>world</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskWorld</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span>
<a name="line-486"></a>          <span class='hs-keyword'>let</span> <span class='hs-varid'>maybeConnection</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskPlayer</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>connections</span> <span class='hs-varid'>world</span><span class='hs-layout'>)</span>
<a name="line-487"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeConnection</span> <span class='hs-keyword'>of</span>
<a name="line-488"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>conn</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>sendToConnection</span> <span class='hs-varid'>conn</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>toText</span><span class='hs-layout'>)</span> <span class='hs-varid'>lines</span>
<a name="line-489"></a>            <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>  <span class='hs-comment'>-- XXX write to server log?</span>
<a name="line-490"></a>
<a name="line-491"></a><a name="forkTask"></a><span class='hs-comment'>-- | Create and queue a task to run the given computation after the given</span>
<a name="line-492"></a><span class='hs-comment'>-- microsecond delay. 'E_INVARG' may be raised if the delay is out of</span>
<a name="line-493"></a><span class='hs-comment'>-- acceptable range. (The given 'TaskId' should have been reserved by a call</span>
<a name="line-494"></a><span class='hs-comment'>-- to 'newTaskId'.)</span>
<a name="line-495"></a><span class='hs-definition'>forkTask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TaskId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-496"></a><span class='hs-definition'>forkTask</span> <span class='hs-varid'>taskId</span> <span class='hs-varid'>usecs</span> <span class='hs-varid'>code</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-497"></a>  <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-498"></a>
<a name="line-499"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>now</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>startTime</span> <span class='hs-varid'>state</span>
<a name="line-500"></a>      <span class='hs-varid'>estimatedWakeup</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>usecs</span> <span class='hs-varop'>/</span> <span class='hs-num'>1000000</span><span class='hs-layout'>)</span> <span class='hs-varop'>`addUTCTime`</span> <span class='hs-varid'>now</span>
<a name="line-501"></a>
<a name="line-502"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>estimatedWakeup</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>now</span> <span class='hs-varop'>||</span> <span class='hs-varid'>estimatedWakeup</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>endOfTime</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_INVARG</span>
<a name="line-503"></a>
<a name="line-504"></a>  <span class='hs-varid'>task</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-varid'>task</span>
<a name="line-505"></a>  <span class='hs-varid'>gen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newRandomGen</span>
<a name="line-506"></a>
<a name="line-507"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>frame</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>currentFrame</span> <span class='hs-layout'>(</span><span class='hs-varid'>stack</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span>
<a name="line-508"></a>
<a name="line-509"></a>      <span class='hs-varid'>frame'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>frame</span> <span class='hs-layout'>{</span>
<a name="line-510"></a>          <span class='hs-varid'>depthLeft</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>depthLeft</span> <span class='hs-varid'>initFrame</span>
<a name="line-511"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>contextStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>contextStack</span> <span class='hs-varid'>initFrame</span>
<a name="line-512"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>lineNumber</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>lineNumber</span> <span class='hs-varid'>frame</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span>
<a name="line-513"></a>        <span class='hs-layout'>}</span>
<a name="line-514"></a>
<a name="line-515"></a>      <span class='hs-varid'>state'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initState</span> <span class='hs-layout'>{</span>
<a name="line-516"></a>          <span class='hs-varid'>ticksLeft</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>15000</span>  <span class='hs-comment'>-- XXX</span>
<a name="line-517"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>stack</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>frame'</span><span class='hs-keyglyph'>]</span>
<a name="line-518"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>startTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>estimatedWakeup</span>
<a name="line-519"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>randomGen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gen</span>
<a name="line-520"></a>        <span class='hs-layout'>}</span>
<a name="line-521"></a>
<a name="line-522"></a>      <span class='hs-varid'>task'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>task</span> <span class='hs-layout'>{</span>
<a name="line-523"></a>          <span class='hs-varid'>taskId</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>taskId</span>
<a name="line-524"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>taskStatus</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Forked</span>
<a name="line-525"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>taskState</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>state'</span>
<a name="line-526"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>taskComputation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>code</span>
<a name="line-527"></a>        <span class='hs-layout'>}</span>
<a name="line-528"></a>
<a name="line-529"></a>  <span class='hs-comment'>-- make sure the forked task doesn't start before the current task commits</span>
<a name="line-530"></a>  <span class='hs-varid'>startSignal</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varid'>newEmptyTMVar</span>
<a name="line-531"></a>
<a name="line-532"></a>  <span class='hs-varid'>threadId</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>requestIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>forkIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-533"></a>    <span class='hs-varid'>delay</span> <span class='hs-varid'>usecs</span>
<a name="line-534"></a>    <span class='hs-varid'>atomically</span> <span class='hs-varop'>$</span> <span class='hs-varid'>takeTMVar</span> <span class='hs-varid'>startSignal</span>
<a name="line-535"></a>    <span class='hs-varid'>now</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-536"></a>    <span class='hs-varid'>void</span> <span class='hs-varop'>$</span> <span class='hs-varid'>runTask</span> <span class='hs-varid'>task'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskState</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>state'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>startTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>now</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-537"></a>
<a name="line-538"></a>  <span class='hs-varid'>modifyWorld</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>world</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-539"></a>    <span class='hs-varid'>world</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tasks</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-varid'>taskId</span> <span class='hs-varid'>task'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>taskThread</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>threadId</span> <span class='hs-layout'>}</span> <span class='hs-varop'>$</span>
<a name="line-540"></a>                    <span class='hs-varid'>tasks</span> <span class='hs-varid'>world</span> <span class='hs-layout'>}</span>
<a name="line-541"></a>  <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>putTMVar</span> <span class='hs-varid'>startSignal</span> <span class='hs-conid'>()</span>
<a name="line-542"></a>
<a name="line-543"></a><a name="delay"></a><span class='hs-comment'>-- | Wait for the given number of microseconds to elapse.</span>
<a name="line-544"></a><span class='hs-definition'>delay</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Integer</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-545"></a><span class='hs-definition'>delay</span> <span class='hs-varid'>usecs</span> <span class='hs-keyglyph'>=</span>
<a name="line-546"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>usecs</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-layout'>(</span><span class='hs-varid'>maxBound</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span>
<a name="line-547"></a>  <span class='hs-keyword'>then</span> <span class='hs-varid'>threadDelay</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>usecs</span><span class='hs-layout'>)</span>
<a name="line-548"></a>  <span class='hs-keyword'>else</span> <span class='hs-varid'>nanosleep</span> <span class='hs-layout'>(</span><span class='hs-varid'>usecs</span> <span class='hs-varop'>*</span> <span class='hs-num'>1000</span><span class='hs-layout'>)</span>
<a name="line-549"></a>
<a name="line-550"></a><a name="InterruptHandler"></a><span class='hs-comment'>-- | A continuation for returning to the task dispatcher to handle an</span>
<a name="line-551"></a><a name="InterruptHandler"></a><span class='hs-comment'>-- interrupt request. Note that calling this continuation implies a commit to</span>
<a name="line-552"></a><a name="InterruptHandler"></a><span class='hs-comment'>-- the current task's transaction.</span>
<a name="line-553"></a><a name="InterruptHandler"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>InterruptHandler</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Interrupt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TaskDisposition</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>TaskDisposition</span><span class='hs-layout'>)</span>
<a name="line-554"></a>
<a name="line-555"></a><a name="interrupt"></a><span class='hs-comment'>-- | Commit the current task's transaction, and return to the task dispatcher</span>
<a name="line-556"></a><span class='hs-comment'>-- with an interrupt request. The task dispatcher may resume execution of the</span>
<a name="line-557"></a><span class='hs-comment'>-- task later if the request is one which supplies an appropriate</span>
<a name="line-558"></a><span class='hs-comment'>-- continuation.</span>
<a name="line-559"></a><span class='hs-definition'>interrupt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TaskDisposition</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-560"></a><span class='hs-definition'>interrupt</span> <span class='hs-varid'>disp</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-561"></a>  <span class='hs-conid'>Interrupt</span> <span class='hs-varid'>handler</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-varid'>interruptHandler</span>
<a name="line-562"></a>  <span class='hs-varid'>handler</span> <span class='hs-varid'>disp</span>
<a name="line-563"></a>  <span class='hs-varid'>error</span> <span class='hs-str'>"Returned from interrupt handler"</span>
<a name="line-564"></a>
<a name="line-565"></a><a name="DelayedIO"></a><span class='hs-comment'>-- | An 'IO' computation to be performed after the current task commits its</span>
<a name="line-566"></a><a name="DelayedIO"></a><span class='hs-comment'>-- 'STM' transaction</span>
<a name="line-567"></a><a name="DelayedIO"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>DelayedIO</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DelayedIO</span> <span class='hs-layout'>{</span> <span class='hs-varid'>runDelayed</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span> <span class='hs-layout'>}</span>
<a name="line-568"></a>
<a name="line-569"></a><a name="instance%20Monoid%20DelayedIO"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Monoid</span> <span class='hs-conid'>DelayedIO</span> <span class='hs-keyword'>where</span>
<a name="line-570"></a>  <span class='hs-varid'>mempty</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DelayedIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-571"></a>  <span class='hs-conid'>DelayedIO</span> <span class='hs-varid'>a</span> <span class='hs-varop'>`mappend`</span> <span class='hs-conid'>DelayedIO</span> <span class='hs-varid'>b</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DelayedIO</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>b</span><span class='hs-layout'>)</span>
<a name="line-572"></a>
<a name="line-573"></a><a name="requestIO"></a><span class='hs-comment'>-- | Interrupt the current task to perform the given IO computation, and</span>
<a name="line-574"></a><span class='hs-comment'>-- return the result. Note this implies a commit of the task's 'STM'</span>
<a name="line-575"></a><span class='hs-comment'>-- transaction.</span>
<a name="line-576"></a><span class='hs-definition'>requestIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-577"></a><span class='hs-definition'>requestIO</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callCC</span> <span class='hs-varop'>$</span> <span class='hs-varid'>interrupt</span> <span class='hs-varop'>.</span> <span class='hs-conid'>RequestIO</span> <span class='hs-varid'>io</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Resume</span>
<a name="line-578"></a>
<a name="line-579"></a><a name="delayIO"></a><span class='hs-comment'>-- | Perform the given IO computation after the current task commits its 'STM'</span>
<a name="line-580"></a><span class='hs-comment'>-- transaction.</span>
<a name="line-581"></a><span class='hs-comment'>--</span>
<a name="line-582"></a><span class='hs-comment'>-- Since general IO can't be performed within a transaction, this is a simple</span>
<a name="line-583"></a><span class='hs-comment'>-- alternative when the value returned by the IO isn't needed.</span>
<a name="line-584"></a><span class='hs-definition'>delayIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-585"></a><span class='hs-definition'>delayIO</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modify</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-586"></a>  <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>delayedIO</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>delayedIO</span> <span class='hs-varid'>state</span> <span class='hs-varop'>`mappend`</span> <span class='hs-conid'>DelayedIO</span> <span class='hs-varid'>io</span> <span class='hs-layout'>}</span>
<a name="line-587"></a>
<a name="line-588"></a><a name="unsafeIOtoMOO"></a><span class='hs-comment'>-- | Unsafely perform the given IO computation within the current 'STM'</span>
<a name="line-589"></a><span class='hs-comment'>-- transaction.</span>
<a name="line-590"></a><span class='hs-comment'>--</span>
<a name="line-591"></a><span class='hs-comment'>-- Since 'STM' transactions may be aborted at any time, the IO is performed in</span>
<a name="line-592"></a><span class='hs-comment'>-- a separate thread in order to guarantee consistency with any finalizers,</span>
<a name="line-593"></a><span class='hs-comment'>-- brackets, and so forth. The IO must be idempotent as it may be run more</span>
<a name="line-594"></a><span class='hs-comment'>-- than once.</span>
<a name="line-595"></a><span class='hs-definition'>unsafeIOtoMOO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-596"></a><span class='hs-definition'>unsafeIOtoMOO</span> <span class='hs-varid'>io</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-597"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>result</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>unsafePerformIO</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-598"></a>        <span class='hs-varid'>r</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEmptyMVar</span>
<a name="line-599"></a>        <span class='hs-varid'>forkIO</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>io</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>putMVar</span> <span class='hs-varid'>r</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Right</span><span class='hs-layout'>)</span> <span class='hs-varop'>`catch`</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-600"></a>          <span class='hs-varid'>putMVar</span> <span class='hs-varid'>r</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SomeException</span><span class='hs-layout'>)</span>
<a name="line-601"></a>        <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>r</span>
<a name="line-602"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>result</span> <span class='hs-keyword'>of</span>
<a name="line-603"></a>    <span class='hs-conid'>Right</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>x</span>
<a name="line-604"></a>    <span class='hs-conid'>Left</span>  <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>throwSTM</span> <span class='hs-varid'>e</span>
<a name="line-605"></a>
<a name="line-606"></a><a name="Environment"></a><span class='hs-comment'>-- | A 'Reader' environment for state that either doesn't change, or can be</span>
<a name="line-607"></a><a name="Environment"></a><span class='hs-comment'>-- locally modified for subcomputations</span>
<a name="line-608"></a><a name="Environment"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Environment</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Env</span> <span class='hs-layout'>{</span>
<a name="line-609"></a>    <span class='hs-varid'>task</span>             <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span>
<a name="line-610"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>interruptHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>InterruptHandler</span>
<a name="line-611"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionHandler</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ExceptionHandler</span>
<a name="line-612"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>indexLength</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Int</span>
<a name="line-613"></a>  <span class='hs-layout'>}</span>
<a name="line-614"></a>
<a name="line-615"></a><a name="initEnvironment"></a><span class='hs-definition'>initEnvironment</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Environment</span>
<a name="line-616"></a><span class='hs-definition'>initEnvironment</span> <span class='hs-varid'>task</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Env</span> <span class='hs-layout'>{</span>
<a name="line-617"></a>    <span class='hs-varid'>task</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>task</span>
<a name="line-618"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>interruptHandler</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Undefined interrupt handler"</span>
<a name="line-619"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionHandler</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Handler</span> <span class='hs-varop'>$</span> <span class='hs-varid'>interrupt</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Uncaught</span>
<a name="line-620"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>indexLength</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"Invalid index context"</span>
<a name="line-621"></a>  <span class='hs-layout'>}</span>
<a name="line-622"></a>
<a name="line-623"></a><a name="TaskState"></a><span class='hs-comment'>-- | A 'State' structure for data that may normally change during computation</span>
<a name="line-624"></a><a name="TaskState"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TaskState</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>State</span> <span class='hs-layout'>{</span>
<a name="line-625"></a>    <span class='hs-varid'>ticksLeft</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-626"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>stack</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span>
<a name="line-627"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>startTime</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>UTCTime</span>
<a name="line-628"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>randomGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StdGen</span>
<a name="line-629"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>delayedIO</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DelayedIO</span>
<a name="line-630"></a>  <span class='hs-layout'>}</span>
<a name="line-631"></a>
<a name="line-632"></a><a name="initState"></a><span class='hs-definition'>initState</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>State</span> <span class='hs-layout'>{</span>
<a name="line-633"></a>    <span class='hs-varid'>ticksLeft</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>30000</span>
<a name="line-634"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>stack</span>     <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-conid'>[]</span>
<a name="line-635"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>startTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>posixSecondsToUTCTime</span> <span class='hs-num'>0</span>
<a name="line-636"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>randomGen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkStdGen</span> <span class='hs-num'>0</span>
<a name="line-637"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>delayedIO</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span>
<a name="line-638"></a>  <span class='hs-layout'>}</span>
<a name="line-639"></a>
<a name="line-640"></a><a name="instance%20Sizeable%20TaskState"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Sizeable</span> <span class='hs-conid'>TaskState</span> <span class='hs-keyword'>where</span>
<a name="line-641"></a>  <span class='hs-varid'>storageBytes</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>=</span>
<a name="line-642"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ticksLeft</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-643"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>stack</span>     <span class='hs-varid'>state</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-644"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>startTime</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-645"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>randomGen</span> <span class='hs-varid'>state</span><span class='hs-layout'>)</span>
<a name="line-646"></a>    <span class='hs-comment'>-- storageBytes (delayedIO state)</span>
<a name="line-647"></a>
<a name="line-648"></a><a name="newState"></a><span class='hs-definition'>newState</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>TaskState</span>
<a name="line-649"></a><span class='hs-definition'>newState</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-650"></a>  <span class='hs-varid'>startTime</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTime</span>
<a name="line-651"></a>  <span class='hs-varid'>gen</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newStdGen</span>
<a name="line-652"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>initState</span> <span class='hs-layout'>{</span>
<a name="line-653"></a>      <span class='hs-varid'>startTime</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>startTime</span>
<a name="line-654"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>randomGen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gen</span>
<a name="line-655"></a>    <span class='hs-layout'>}</span>
<a name="line-656"></a>
<a name="line-657"></a><a name="getWorld"></a><span class='hs-definition'>getWorld</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>World</span>
<a name="line-658"></a><span class='hs-definition'>getWorld</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>.</span> <span class='hs-varid'>readTVar</span> <span class='hs-varop'>.</span> <span class='hs-varid'>taskWorld</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>asks</span> <span class='hs-varid'>task</span>
<a name="line-659"></a>
<a name="line-660"></a><a name="getWorld'"></a><span class='hs-definition'>getWorld'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-layout'>(</span><span class='hs-conid'>TVar</span> <span class='hs-conid'>World</span><span class='hs-layout'>)</span>
<a name="line-661"></a><span class='hs-definition'>getWorld'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>asks</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskWorld</span> <span class='hs-varop'>.</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span>
<a name="line-662"></a>
<a name="line-663"></a><a name="putWorld"></a><span class='hs-definition'>putWorld</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>World</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-664"></a><span class='hs-definition'>putWorld</span> <span class='hs-varid'>world</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-665"></a>  <span class='hs-varid'>world'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWorld'</span>
<a name="line-666"></a>  <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeTVar</span> <span class='hs-varid'>world'</span> <span class='hs-varid'>world</span>
<a name="line-667"></a>
<a name="line-668"></a><a name="modifyWorld"></a><span class='hs-definition'>modifyWorld</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>World</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>World</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-669"></a><span class='hs-definition'>modifyWorld</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-670"></a>  <span class='hs-varid'>world'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWorld'</span>
<a name="line-671"></a>  <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyTVar</span> <span class='hs-varid'>world'</span> <span class='hs-varid'>f</span>
<a name="line-672"></a>
<a name="line-673"></a><a name="getTask"></a><span class='hs-definition'>getTask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TaskId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Task</span><span class='hs-layout'>)</span>
<a name="line-674"></a><span class='hs-definition'>getTask</span> <span class='hs-varid'>taskId</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-varid'>taskId</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tasks</span><span class='hs-layout'>)</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>getWorld</span>
<a name="line-675"></a>
<a name="line-676"></a><a name="putTask"></a><span class='hs-definition'>putTask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-677"></a><span class='hs-definition'>putTask</span> <span class='hs-varid'>task</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyWorld</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>world</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-678"></a>  <span class='hs-varid'>world</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tasks</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskId</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varid'>task</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tasks</span> <span class='hs-varid'>world</span> <span class='hs-layout'>}</span>
<a name="line-679"></a>
<a name="line-680"></a><a name="purgeTask"></a><span class='hs-definition'>purgeTask</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-681"></a><span class='hs-definition'>purgeTask</span> <span class='hs-varid'>task</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyWorld</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>world</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-682"></a>  <span class='hs-varid'>world</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tasks</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>delete</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskId</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tasks</span> <span class='hs-varid'>world</span> <span class='hs-layout'>}</span>
<a name="line-683"></a>
<a name="line-684"></a><a name="getDatabase"></a><span class='hs-definition'>getDatabase</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Database</span>
<a name="line-685"></a><span class='hs-definition'>getDatabase</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>database</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>getWorld</span>
<a name="line-686"></a>
<a name="line-687"></a><a name="putDatabase"></a><span class='hs-definition'>putDatabase</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Database</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-688"></a><span class='hs-definition'>putDatabase</span> <span class='hs-varid'>db</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyWorld</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>world</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>world</span> <span class='hs-layout'>{</span> <span class='hs-varid'>database</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>db</span> <span class='hs-layout'>}</span>
<a name="line-689"></a>
<a name="line-690"></a><a name="getPlayer"></a><span class='hs-definition'>getPlayer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>ObjId</span>
<a name="line-691"></a><span class='hs-definition'>getPlayer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>asks</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskPlayer</span> <span class='hs-varop'>.</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span>
<a name="line-692"></a>
<a name="line-693"></a><a name="getObject"></a><span class='hs-definition'>getObject</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Object</span><span class='hs-layout'>)</span>
<a name="line-694"></a><span class='hs-definition'>getObject</span> <span class='hs-varid'>oid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>.</span> <span class='hs-varid'>dbObject</span> <span class='hs-varid'>oid</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>getDatabase</span>
<a name="line-695"></a>
<a name="line-696"></a><a name="getObjectName"></a><span class='hs-definition'>getObjectName</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>StrT</span>
<a name="line-697"></a><span class='hs-definition'>getObjectName</span> <span class='hs-varid'>oid</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-698"></a>  <span class='hs-varid'>obj</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getObject</span> <span class='hs-varid'>oid</span>
<a name="line-699"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>objNum</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>fromText</span> <span class='hs-layout'>(</span><span class='hs-varid'>toText</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>oid</span><span class='hs-layout'>)</span>
<a name="line-700"></a>
<a name="line-701"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>maybe</span> <span class='hs-varid'>objNum</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>concat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>objectName</span> <span class='hs-varid'>obj</span><span class='hs-layout'>,</span>
<a name="line-702"></a>                                             <span class='hs-str'>" ("</span><span class='hs-layout'>,</span> <span class='hs-varid'>objNum</span><span class='hs-layout'>,</span> <span class='hs-str'>")"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>obj</span>
<a name="line-703"></a>
<a name="line-704"></a><a name="getProperty"></a><span class='hs-definition'>getProperty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Object</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Property</span>
<a name="line-705"></a><span class='hs-definition'>getProperty</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-706"></a>  <span class='hs-varid'>maybeProp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupProperty</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>name</span>
<a name="line-707"></a>  <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>raise</span> <span class='hs-conid'>E_PROPNF</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-varid'>maybeProp</span>
<a name="line-708"></a>
<a name="line-709"></a><a name="getVerb"></a><span class='hs-definition'>getVerb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Object</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Verb</span>
<a name="line-710"></a><span class='hs-definition'>getVerb</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>desc</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Str</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-711"></a>  <span class='hs-varid'>maybeVerb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupVerb</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>desc</span>
<a name="line-712"></a>  <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>raise</span> <span class='hs-conid'>E_VERBNF</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-varid'>maybeVerb</span>
<a name="line-713"></a><span class='hs-definition'>getVerb</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>desc</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Int</span> <span class='hs-varid'>index</span><span class='hs-layout'>)</span>
<a name="line-714"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>index</span> <span class='hs-varop'>&lt;</span> <span class='hs-num'>1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_INVARG</span>
<a name="line-715"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-716"></a>    <span class='hs-varid'>maybeVerb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupVerb</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>desc</span>
<a name="line-717"></a>    <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>raise</span> <span class='hs-conid'>E_VERBNF</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-varid'>maybeVerb</span>
<a name="line-718"></a><span class='hs-definition'>getVerb</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_TYPE</span>
<a name="line-719"></a>
<a name="line-720"></a><a name="findVerb"></a><span class='hs-definition'>findVerb</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Verb</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>ObjId</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Verb</span><span class='hs-layout'>)</span>
<a name="line-721"></a><span class='hs-definition'>findVerb</span> <span class='hs-varid'>acceptable</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>findVerb'</span>
<a name="line-722"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>findVerb'</span> <span class='hs-varid'>oid</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-723"></a>          <span class='hs-varid'>maybeObj</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getObject</span> <span class='hs-varid'>oid</span>
<a name="line-724"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeObj</span> <span class='hs-keyword'>of</span>
<a name="line-725"></a>            <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-726"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-727"></a>              <span class='hs-varid'>maybeVerb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>searchVerbs</span> <span class='hs-layout'>(</span><span class='hs-varid'>objectVerbs</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span>
<a name="line-728"></a>              <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeVerb</span> <span class='hs-keyword'>of</span>
<a name="line-729"></a>                <span class='hs-conid'>Just</span> <span class='hs-varid'>verb</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>verb</span><span class='hs-layout'>)</span>
<a name="line-730"></a>                <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-731"></a>                             <span class='hs-varid'>findVerb'</span> <span class='hs-layout'>(</span><span class='hs-varid'>objectParent</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span>
<a name="line-732"></a>
<a name="line-733"></a>        <span class='hs-varid'>searchVerbs</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>names</span><span class='hs-layout'>,</span><span class='hs-varid'>verbTVar</span><span class='hs-layout'>)</span><span class='hs-conop'>:</span><span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-734"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>verbNameMatch</span> <span class='hs-varid'>name</span> <span class='hs-varid'>names</span>
<a name="line-735"></a>          <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span>
<a name="line-736"></a>            <span class='hs-varid'>verb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readTVar</span> <span class='hs-varid'>verbTVar</span>
<a name="line-737"></a>            <span class='hs-keyword'>if</span> <span class='hs-varid'>acceptable</span> <span class='hs-varid'>verb</span>
<a name="line-738"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>verb</span><span class='hs-layout'>)</span>
<a name="line-739"></a>              <span class='hs-keyword'>else</span> <span class='hs-varid'>searchVerbs</span> <span class='hs-varid'>rest</span>
<a name="line-740"></a>          <span class='hs-keyword'>else</span> <span class='hs-varid'>searchVerbs</span> <span class='hs-varid'>rest</span>
<a name="line-741"></a>        <span class='hs-varid'>searchVerbs</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-742"></a>
<a name="line-743"></a><a name="callSystemVerb"></a><span class='hs-definition'>callSystemVerb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Value</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span>
<a name="line-744"></a><span class='hs-definition'>callSystemVerb</span> <span class='hs-varid'>name</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callSystemVerb'</span> <span class='hs-varid'>systemObject</span> <span class='hs-varid'>name</span> <span class='hs-varid'>args</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-745"></a>
<a name="line-746"></a><a name="callSystemVerb'"></a><span class='hs-definition'>callSystemVerb'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Value</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span>
<a name="line-747"></a><span class='hs-definition'>callSystemVerb'</span> <span class='hs-varid'>object</span> <span class='hs-varid'>name</span> <span class='hs-varid'>args</span> <span class='hs-varid'>argstr</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-748"></a>  <span class='hs-varid'>player</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-layout'>(</span><span class='hs-varid'>taskPlayer</span> <span class='hs-varop'>.</span> <span class='hs-varid'>task</span><span class='hs-layout'>)</span>
<a name="line-749"></a>  <span class='hs-varid'>maybeVerb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findVerb</span> <span class='hs-varid'>verbPermX</span> <span class='hs-varid'>name</span> <span class='hs-varid'>object</span>
<a name="line-750"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeVerb</span> <span class='hs-keyword'>of</span>
<a name="line-751"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>verbOid</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>verb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-752"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVariables</span> <span class='hs-keyglyph'>[</span>
<a name="line-753"></a>              <span class='hs-layout'>(</span><span class='hs-str'>"player"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>player</span><span class='hs-layout'>)</span>
<a name="line-754"></a>            <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"this"</span>  <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>object</span><span class='hs-layout'>)</span>
<a name="line-755"></a>            <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"verb"</span>  <span class='hs-layout'>,</span> <span class='hs-conid'>Str</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-756"></a>            <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"args"</span>  <span class='hs-layout'>,</span> <span class='hs-varid'>fromList</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-757"></a>            <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"argstr"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Str</span> <span class='hs-varid'>argstr</span><span class='hs-layout'>)</span>
<a name="line-758"></a>            <span class='hs-keyglyph'>]</span>
<a name="line-759"></a>      <span class='hs-conid'>Just</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>runVerb</span> <span class='hs-varid'>verb</span> <span class='hs-varid'>initFrame</span> <span class='hs-layout'>{</span>
<a name="line-760"></a>          <span class='hs-varid'>variables</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vars</span>
<a name="line-761"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>verbName</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-762"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>verbLocation</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbOid</span>
<a name="line-763"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>initialThis</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>object</span>
<a name="line-764"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>initialPlayer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>player</span>
<a name="line-765"></a>        <span class='hs-layout'>}</span>
<a name="line-766"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-767"></a>
<a name="line-768"></a><a name="callCommandVerb"></a><span class='hs-definition'>callCommandVerb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ObjId</span><span class='hs-layout'>,</span> <span class='hs-conid'>Verb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-769"></a>                   <span class='hs-conid'>Command</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ObjId</span><span class='hs-layout'>,</span> <span class='hs-conid'>ObjId</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-770"></a><span class='hs-definition'>callCommandVerb</span> <span class='hs-varid'>player</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbOid</span><span class='hs-layout'>,</span> <span class='hs-varid'>verb</span><span class='hs-layout'>)</span> <span class='hs-varid'>this</span> <span class='hs-varid'>command</span> <span class='hs-layout'>(</span><span class='hs-varid'>dobj</span><span class='hs-layout'>,</span> <span class='hs-varid'>iobj</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-771"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>vars</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVariables</span> <span class='hs-keyglyph'>[</span>
<a name="line-772"></a>          <span class='hs-layout'>(</span><span class='hs-str'>"player"</span> <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>player</span><span class='hs-layout'>)</span>
<a name="line-773"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"this"</span>   <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>this</span><span class='hs-layout'>)</span>
<a name="line-774"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"caller"</span> <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>player</span><span class='hs-layout'>)</span>
<a name="line-775"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"verb"</span>   <span class='hs-layout'>,</span> <span class='hs-conid'>Str</span>        <span class='hs-varop'>$</span> <span class='hs-varid'>commandVerb</span>    <span class='hs-varid'>command</span><span class='hs-layout'>)</span>
<a name="line-776"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"argstr"</span> <span class='hs-layout'>,</span> <span class='hs-conid'>Str</span>        <span class='hs-varop'>$</span> <span class='hs-varid'>commandArgStr</span>  <span class='hs-varid'>command</span><span class='hs-layout'>)</span>
<a name="line-777"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"args"</span>   <span class='hs-layout'>,</span> <span class='hs-varid'>stringList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>commandArgs</span>    <span class='hs-varid'>command</span><span class='hs-layout'>)</span>
<a name="line-778"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"dobjstr"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Str</span>        <span class='hs-varop'>$</span> <span class='hs-varid'>commandDObjStr</span> <span class='hs-varid'>command</span><span class='hs-layout'>)</span>
<a name="line-779"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"dobj"</span>   <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>dobj</span><span class='hs-layout'>)</span>
<a name="line-780"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"prepstr"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Str</span>        <span class='hs-varop'>$</span> <span class='hs-varid'>commandPrepStr</span> <span class='hs-varid'>command</span><span class='hs-layout'>)</span>
<a name="line-781"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"iobjstr"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Str</span>        <span class='hs-varop'>$</span> <span class='hs-varid'>commandIObjStr</span> <span class='hs-varid'>command</span><span class='hs-layout'>)</span>
<a name="line-782"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"iobj"</span>   <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>iobj</span><span class='hs-layout'>)</span>
<a name="line-783"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-784"></a>
<a name="line-785"></a>  <span class='hs-varid'>runVerb</span> <span class='hs-varid'>verb</span> <span class='hs-varid'>initFrame</span> <span class='hs-layout'>{</span>
<a name="line-786"></a>      <span class='hs-varid'>variables</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vars</span>
<a name="line-787"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>verbName</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>commandVerb</span> <span class='hs-varid'>command</span>
<a name="line-788"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>verbLocation</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbOid</span>
<a name="line-789"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>initialThis</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this</span>
<a name="line-790"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>initialPlayer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>player</span>
<a name="line-791"></a>    <span class='hs-layout'>}</span>
<a name="line-792"></a>
<a name="line-793"></a><a name="callVerb'"></a><span class='hs-definition'>callVerb'</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ObjId</span><span class='hs-layout'>,</span> <span class='hs-conid'>Verb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Value</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-794"></a><span class='hs-definition'>callVerb'</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbOid</span><span class='hs-layout'>,</span> <span class='hs-varid'>verb</span><span class='hs-layout'>)</span> <span class='hs-varid'>this</span> <span class='hs-varid'>name</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-795"></a>  <span class='hs-varid'>thisFrame</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>frame</span> <span class='hs-varid'>id</span>
<a name="line-796"></a>  <span class='hs-varid'>wizard</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isWizard</span> <span class='hs-layout'>(</span><span class='hs-varid'>permissions</span> <span class='hs-varid'>thisFrame</span><span class='hs-layout'>)</span>
<a name="line-797"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>player</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>wizard</span><span class='hs-layout'>,</span> <span class='hs-varid'>vars</span> <span class='hs-conid'>M</span><span class='hs-varop'>.!</span> <span class='hs-str'>"player"</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-798"></a>        <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>oid</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>oid</span>
<a name="line-799"></a>        <span class='hs-keyword'>_</span>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>initialPlayer</span> <span class='hs-varid'>thisFrame</span>
<a name="line-800"></a>      <span class='hs-varid'>vars</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>variables</span> <span class='hs-varid'>thisFrame</span>
<a name="line-801"></a>      <span class='hs-varid'>vars'</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkVariables</span> <span class='hs-keyglyph'>[</span>
<a name="line-802"></a>          <span class='hs-layout'>(</span><span class='hs-str'>"this"</span>   <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>this</span><span class='hs-layout'>)</span>
<a name="line-803"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"verb"</span>   <span class='hs-layout'>,</span> <span class='hs-conid'>Str</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-804"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"args"</span>   <span class='hs-layout'>,</span> <span class='hs-varid'>fromList</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-805"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"caller"</span> <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varop'>$</span> <span class='hs-varid'>initialThis</span> <span class='hs-varid'>thisFrame</span><span class='hs-layout'>)</span>
<a name="line-806"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"player"</span> <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>player</span><span class='hs-layout'>)</span>
<a name="line-807"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"argstr"</span> <span class='hs-layout'>,</span> <span class='hs-varid'>vars</span> <span class='hs-conid'>M</span><span class='hs-varop'>.!</span> <span class='hs-str'>"argstr"</span><span class='hs-layout'>)</span>
<a name="line-808"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"dobjstr"</span><span class='hs-layout'>,</span> <span class='hs-varid'>vars</span> <span class='hs-conid'>M</span><span class='hs-varop'>.!</span> <span class='hs-str'>"dobjstr"</span><span class='hs-layout'>)</span>
<a name="line-809"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"dobj"</span>   <span class='hs-layout'>,</span> <span class='hs-varid'>vars</span> <span class='hs-conid'>M</span><span class='hs-varop'>.!</span> <span class='hs-str'>"dobj"</span><span class='hs-layout'>)</span>
<a name="line-810"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"prepstr"</span><span class='hs-layout'>,</span> <span class='hs-varid'>vars</span> <span class='hs-conid'>M</span><span class='hs-varop'>.!</span> <span class='hs-str'>"prepstr"</span><span class='hs-layout'>)</span>
<a name="line-811"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"iobjstr"</span><span class='hs-layout'>,</span> <span class='hs-varid'>vars</span> <span class='hs-conid'>M</span><span class='hs-varop'>.!</span> <span class='hs-str'>"iobjstr"</span><span class='hs-layout'>)</span>
<a name="line-812"></a>        <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"iobj"</span>   <span class='hs-layout'>,</span> <span class='hs-varid'>vars</span> <span class='hs-conid'>M</span><span class='hs-varop'>.!</span> <span class='hs-str'>"iobj"</span><span class='hs-layout'>)</span>
<a name="line-813"></a>        <span class='hs-keyglyph'>]</span>
<a name="line-814"></a>
<a name="line-815"></a>  <span class='hs-varid'>runVerb</span> <span class='hs-varid'>verb</span> <span class='hs-varid'>initFrame</span> <span class='hs-layout'>{</span>
<a name="line-816"></a>      <span class='hs-varid'>variables</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vars'</span>
<a name="line-817"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>verbName</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-818"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>verbLocation</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbOid</span>
<a name="line-819"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>initialThis</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this</span>
<a name="line-820"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>initialPlayer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>player</span>
<a name="line-821"></a>    <span class='hs-layout'>}</span>
<a name="line-822"></a>
<a name="line-823"></a><a name="callVerb"></a><span class='hs-definition'>callVerb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Value</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-824"></a><span class='hs-definition'>callVerb</span> <span class='hs-varid'>verbLoc</span> <span class='hs-varid'>this</span> <span class='hs-varid'>name</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-825"></a>  <span class='hs-varid'>maybeVerb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findVerb</span> <span class='hs-varid'>verbPermX</span> <span class='hs-varid'>name</span> <span class='hs-varid'>verbLoc</span>
<a name="line-826"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeVerb</span> <span class='hs-keyword'>of</span>
<a name="line-827"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>verbOid</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>verb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>callVerb'</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbOid</span><span class='hs-layout'>,</span> <span class='hs-varid'>verb</span><span class='hs-layout'>)</span> <span class='hs-varid'>this</span> <span class='hs-varid'>name</span> <span class='hs-varid'>args</span>
<a name="line-828"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Nothing</span>     <span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span>         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_INVIND</span>
<a name="line-829"></a>    <span class='hs-layout'>(</span><span class='hs-keyword'>_</span>           <span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_VERBNF</span>
<a name="line-830"></a>
<a name="line-831"></a><a name="callFromFunc"></a><span class='hs-definition'>callFromFunc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ObjId</span><span class='hs-layout'>,</span> <span class='hs-conid'>StrT</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Value</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span>
<a name="line-832"></a><span class='hs-definition'>callFromFunc</span> <span class='hs-varid'>func</span> <span class='hs-varid'>index</span> <span class='hs-layout'>(</span><span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-833"></a>  <span class='hs-varid'>maybeVerb</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findVerb</span> <span class='hs-varid'>verbPermX</span> <span class='hs-varid'>name</span> <span class='hs-varid'>oid</span>
<a name="line-834"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeVerb</span> <span class='hs-keyword'>of</span>
<a name="line-835"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>verbOid</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>verb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftM</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>evalFromFunc</span> <span class='hs-varid'>func</span> <span class='hs-varid'>index</span> <span class='hs-varop'>$</span>
<a name="line-836"></a>                                 <span class='hs-varid'>callVerb'</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbOid</span><span class='hs-layout'>,</span> <span class='hs-varid'>verb</span><span class='hs-layout'>)</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>name</span> <span class='hs-varid'>args</span>
<a name="line-837"></a>    <span class='hs-keyword'>_</span>                         <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-838"></a>
<a name="line-839"></a><a name="evalFromFunc"></a><span class='hs-definition'>evalFromFunc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IntT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-840"></a><span class='hs-definition'>evalFromFunc</span> <span class='hs-varid'>func</span> <span class='hs-varid'>index</span> <span class='hs-varid'>code</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-841"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>depthLeft</span><span class='hs-layout'>,</span> <span class='hs-varid'>player</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>frame</span> <span class='hs-layout'>(</span><span class='hs-varid'>depthLeft</span> <span class='hs-varop'>&amp;&amp;&amp;</span> <span class='hs-varid'>initialPlayer</span><span class='hs-layout'>)</span>
<a name="line-842"></a>  <span class='hs-varid'>pushFrame</span> <span class='hs-varid'>initFrame</span> <span class='hs-layout'>{</span>
<a name="line-843"></a>      <span class='hs-varid'>depthLeft</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>depthLeft</span>
<a name="line-844"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>verbName</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>func</span>
<a name="line-845"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>initialPlayer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>player</span>
<a name="line-846"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>builtinFunc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-847"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>lineNumber</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>index</span>
<a name="line-848"></a>    <span class='hs-layout'>}</span>
<a name="line-849"></a>  <span class='hs-varid'>value</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>code</span> <span class='hs-varop'>`catchException`</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>except</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-850"></a>    <span class='hs-varid'>popFrame</span>
<a name="line-851"></a>    <span class='hs-varid'>passException</span> <span class='hs-varid'>except</span>
<a name="line-852"></a>  <span class='hs-varid'>popFrame</span>
<a name="line-853"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>value</span>
<a name="line-854"></a>
<a name="line-855"></a><a name="runVerb"></a><span class='hs-definition'>runVerb</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Verb</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackFrame</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-856"></a><span class='hs-definition'>runVerb</span> <span class='hs-varid'>verb</span> <span class='hs-varid'>verbFrame</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-857"></a>  <span class='hs-conid'>Stack</span> <span class='hs-varid'>frames</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>stack</span>
<a name="line-858"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>depthLeft'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>depthLeft</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>frames</span> <span class='hs-keyword'>of</span>
<a name="line-859"></a>        <span class='hs-varid'>frame</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>frame</span>
<a name="line-860"></a>        <span class='hs-conid'>[]</span>      <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>initFrame</span>
<a name="line-861"></a>  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>depthLeft'</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_MAXREC</span>
<a name="line-862"></a>
<a name="line-863"></a>  <span class='hs-varid'>pushFrame</span> <span class='hs-varid'>verbFrame</span> <span class='hs-layout'>{</span>
<a name="line-864"></a>      <span class='hs-varid'>depthLeft</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>depthLeft'</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span>
<a name="line-865"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>debugBit</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbPermD</span> <span class='hs-varid'>verb</span>
<a name="line-866"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>permissions</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbOwner</span> <span class='hs-varid'>verb</span>
<a name="line-867"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>verbFullName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>verbNames</span> <span class='hs-varid'>verb</span>
<a name="line-868"></a>    <span class='hs-layout'>}</span>
<a name="line-869"></a>  <span class='hs-varid'>value</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>verbCode</span> <span class='hs-varid'>verb</span> <span class='hs-varop'>`catchException`</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>except</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-870"></a>    <span class='hs-varid'>popFrame</span>
<a name="line-871"></a>    <span class='hs-varid'>passException</span> <span class='hs-varid'>except</span>
<a name="line-872"></a>  <span class='hs-varid'>popFrame</span>
<a name="line-873"></a>
<a name="line-874"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>value</span>
<a name="line-875"></a>
<a name="line-876"></a><a name="runTick"></a><span class='hs-definition'>runTick</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-877"></a><span class='hs-definition'>runTick</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-878"></a>  <span class='hs-varid'>ticksLeft</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>ticksLeft</span>
<a name="line-879"></a>  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>ticksLeft</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>interrupt</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Timeout</span> <span class='hs-conid'>Ticks</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>stack</span>
<a name="line-880"></a>  <span class='hs-varid'>modify</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ticksLeft</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ticksLeft</span> <span class='hs-comment'>-</span> <span class='hs-num'>1</span> <span class='hs-layout'>}</span>
<a name="line-881"></a>
<a name="line-882"></a><a name="modifyProperty"></a><span class='hs-definition'>modifyProperty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Object</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Property</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Property</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-883"></a><span class='hs-definition'>modifyProperty</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>name</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span>
<a name="line-884"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupPropertyRef</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-885"></a>    <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_PROPNF</span>
<a name="line-886"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>propTVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-887"></a>      <span class='hs-varid'>prop</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readTVar</span> <span class='hs-varid'>propTVar</span>
<a name="line-888"></a>      <span class='hs-varid'>prop'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-varid'>prop</span>
<a name="line-889"></a>      <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeTVar</span> <span class='hs-varid'>propTVar</span> <span class='hs-varid'>prop'</span>
<a name="line-890"></a>
<a name="line-891"></a><a name="modifyVerb"></a><span class='hs-definition'>modifyVerb</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ObjId</span><span class='hs-layout'>,</span> <span class='hs-conid'>Object</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Verb</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Verb</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-892"></a><span class='hs-definition'>modifyVerb</span> <span class='hs-layout'>(</span><span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span> <span class='hs-varid'>desc</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span>
<a name="line-893"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupVerbRef</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>desc</span> <span class='hs-keyword'>of</span>
<a name="line-894"></a>    <span class='hs-conid'>Nothing</span>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_VERBNF</span>
<a name="line-895"></a>    <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>index</span><span class='hs-layout'>,</span> <span class='hs-varid'>verbTVar</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-896"></a>      <span class='hs-varid'>verb</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>readTVar</span> <span class='hs-varid'>verbTVar</span>
<a name="line-897"></a>      <span class='hs-varid'>verb'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>f</span> <span class='hs-varid'>verb</span>
<a name="line-898"></a>      <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>writeTVar</span> <span class='hs-varid'>verbTVar</span> <span class='hs-varid'>verb'</span>
<a name="line-899"></a>      <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbNames</span> <span class='hs-varid'>verb</span> <span class='hs-varop'>`</span><span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>equal</span><span class='hs-varop'>`</span> <span class='hs-varid'>verbNames</span> <span class='hs-varid'>verb'</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-900"></a>        <span class='hs-varid'>db</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDatabase</span>
<a name="line-901"></a>        <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyObject</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>db</span> <span class='hs-varop'>$</span> <span class='hs-varid'>replaceVerb</span> <span class='hs-varid'>index</span> <span class='hs-varid'>verb'</span>
<a name="line-902"></a>
<a name="line-903"></a><a name="readProperty"></a><span class='hs-definition'>readProperty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span>
<a name="line-904"></a><span class='hs-definition'>readProperty</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>name</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-905"></a>  <span class='hs-varid'>maybeObj</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getObject</span> <span class='hs-varid'>oid</span>
<a name="line-906"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeObj</span> <span class='hs-keyword'>of</span>
<a name="line-907"></a>    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-908"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>search</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>.</span> <span class='hs-layout'>(</span><span class='hs-varop'>$</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-909"></a>                <span class='hs-varid'>builtinProperty</span> <span class='hs-varid'>name</span>
<a name="line-910"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>search</span> <span class='hs-varid'>obj</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-911"></a>          <span class='hs-varid'>maybeProp</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lookupProperty</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>name</span>
<a name="line-912"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeProp</span> <span class='hs-keyword'>of</span>
<a name="line-913"></a>            <span class='hs-conid'>Nothing</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-914"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>prop</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>propertyValue</span> <span class='hs-varid'>prop</span> <span class='hs-keyword'>of</span>
<a name="line-915"></a>              <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-916"></a>                <span class='hs-varid'>parentObj</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span> <span class='hs-varid'>getObject</span> <span class='hs-layout'>(</span><span class='hs-varid'>objectParent</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span>
<a name="line-917"></a>                <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>error</span> <span class='hs-varop'>$</span> <span class='hs-str'>"No inherited value for property "</span> <span class='hs-varop'>++</span>
<a name="line-918"></a>                       <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>toString</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varid'>search</span> <span class='hs-varid'>parentObj</span>
<a name="line-919"></a>              <span class='hs-varid'>just</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>just</span>
<a name="line-920"></a>
<a name="line-921"></a><a name="writeProperty"></a><span class='hs-definition'>writeProperty</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-922"></a><span class='hs-definition'>writeProperty</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>name</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-923"></a>  <span class='hs-varid'>maybeObj</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getObject</span> <span class='hs-varid'>oid</span>
<a name="line-924"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeObj</span> <span class='hs-keyword'>of</span>
<a name="line-925"></a>    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-926"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-927"></a>      <span class='hs-keyword'>if</span> <span class='hs-varid'>isBuiltinProperty</span> <span class='hs-varid'>name</span>
<a name="line-928"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>setBuiltinProperty</span> <span class='hs-layout'>(</span><span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span> <span class='hs-varid'>name</span> <span class='hs-varid'>value</span>
<a name="line-929"></a>      <span class='hs-keyword'>else</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupPropertyRef</span> <span class='hs-varid'>obj</span> <span class='hs-varid'>name</span> <span class='hs-keyword'>of</span>
<a name="line-930"></a>        <span class='hs-conid'>Nothing</span>       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-931"></a>        <span class='hs-conid'>Just</span> <span class='hs-varid'>propTVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-932"></a>          <span class='hs-varid'>prop</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readTVar</span> <span class='hs-varid'>propTVar</span>
<a name="line-933"></a>          <span class='hs-varid'>writeTVar</span> <span class='hs-varid'>propTVar</span> <span class='hs-varid'>prop</span> <span class='hs-layout'>{</span> <span class='hs-varid'>propertyValue</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>value</span> <span class='hs-layout'>}</span>
<a name="line-934"></a>
<a name="line-935"></a><a name="setBuiltinProperty"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>ObjId</span><span class='hs-layout'>,</span> <span class='hs-conid'>Object</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-936"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-layout'>(</span><span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span> <span class='hs-str'>"name"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-937"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>objectIsPlayer</span> <span class='hs-varid'>obj</span>
<a name="line-938"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>checkWizard</span>
<a name="line-939"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>checkPermission</span> <span class='hs-layout'>(</span><span class='hs-varid'>objectOwner</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span>
<a name="line-940"></a>  <span class='hs-varid'>db</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDatabase</span>
<a name="line-941"></a>  <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyObject</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>db</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>obj</span> <span class='hs-layout'>{</span> <span class='hs-varid'>objectName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span>
<a name="line-942"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-layout'>(</span><span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-str'>"owner"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Obj</span> <span class='hs-varid'>owner</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-943"></a>  <span class='hs-varid'>checkWizard</span>
<a name="line-944"></a>  <span class='hs-varid'>db</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDatabase</span>
<a name="line-945"></a>  <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyObject</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>db</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>obj</span> <span class='hs-layout'>{</span> <span class='hs-varid'>objectOwner</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>owner</span> <span class='hs-layout'>}</span>
<a name="line-946"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-keyword'>_</span> <span class='hs-str'>"location"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Obj</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_PERM</span>
<a name="line-947"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-keyword'>_</span> <span class='hs-str'>"contents"</span> <span class='hs-layout'>(</span><span class='hs-conid'>Lst</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_PERM</span>
<a name="line-948"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-layout'>(</span><span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-str'>"programmer"</span> <span class='hs-varid'>bit</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-949"></a>  <span class='hs-varid'>checkWizard</span>
<a name="line-950"></a>  <span class='hs-varid'>db</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDatabase</span>
<a name="line-951"></a>  <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyObject</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>db</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-952"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>obj</span> <span class='hs-layout'>{</span> <span class='hs-varid'>objectProgrammer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>truthOf</span> <span class='hs-varid'>bit</span> <span class='hs-layout'>}</span>
<a name="line-953"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-layout'>(</span><span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-str'>"wizard"</span> <span class='hs-varid'>bit</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-954"></a>  <span class='hs-varid'>checkWizard</span>
<a name="line-955"></a>  <span class='hs-varid'>db</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDatabase</span>
<a name="line-956"></a>  <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyObject</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>db</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-957"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>obj</span> <span class='hs-layout'>{</span> <span class='hs-varid'>objectWizard</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>truthOf</span> <span class='hs-varid'>bit</span> <span class='hs-layout'>}</span>
<a name="line-958"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-layout'>(</span><span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span> <span class='hs-str'>"r"</span> <span class='hs-varid'>bit</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-959"></a>  <span class='hs-varid'>checkPermission</span> <span class='hs-layout'>(</span><span class='hs-varid'>objectOwner</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span>
<a name="line-960"></a>  <span class='hs-varid'>db</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDatabase</span>
<a name="line-961"></a>  <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyObject</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>db</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-962"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>obj</span> <span class='hs-layout'>{</span> <span class='hs-varid'>objectPermR</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>truthOf</span> <span class='hs-varid'>bit</span> <span class='hs-layout'>}</span>
<a name="line-963"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-layout'>(</span><span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span> <span class='hs-str'>"w"</span> <span class='hs-varid'>bit</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-964"></a>  <span class='hs-varid'>checkPermission</span> <span class='hs-layout'>(</span><span class='hs-varid'>objectOwner</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span>
<a name="line-965"></a>  <span class='hs-varid'>db</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDatabase</span>
<a name="line-966"></a>  <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyObject</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>db</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-967"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>obj</span> <span class='hs-layout'>{</span> <span class='hs-varid'>objectPermW</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>truthOf</span> <span class='hs-varid'>bit</span> <span class='hs-layout'>}</span>
<a name="line-968"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-layout'>(</span><span class='hs-varid'>oid</span><span class='hs-layout'>,</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span> <span class='hs-str'>"f"</span> <span class='hs-varid'>bit</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-969"></a>  <span class='hs-varid'>checkPermission</span> <span class='hs-layout'>(</span><span class='hs-varid'>objectOwner</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span>
<a name="line-970"></a>  <span class='hs-varid'>db</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDatabase</span>
<a name="line-971"></a>  <span class='hs-varid'>liftSTM</span> <span class='hs-varop'>$</span> <span class='hs-varid'>modifyObject</span> <span class='hs-varid'>oid</span> <span class='hs-varid'>db</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-972"></a>    <span class='hs-varid'>return</span> <span class='hs-varid'>obj</span> <span class='hs-layout'>{</span> <span class='hs-varid'>objectPermF</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>truthOf</span> <span class='hs-varid'>bit</span> <span class='hs-layout'>}</span>
<a name="line-973"></a><span class='hs-definition'>setBuiltinProperty</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_TYPE</span>
<a name="line-974"></a>
<a name="line-975"></a><a name="CallStack"></a><span class='hs-comment'>-- | The stack of verb and/or built-in function frames</span>
<a name="line-976"></a><a name="CallStack"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>CallStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StackFrame</span><span class='hs-keyglyph'>]</span>
<a name="line-977"></a>                  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-978"></a>
<a name="line-979"></a><a name="instance%20Sizeable%20CallStack"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Sizeable</span> <span class='hs-conid'>CallStack</span> <span class='hs-keyword'>where</span>
<a name="line-980"></a>  <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stack</span> <span class='hs-varid'>stack</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>storageBytes</span> <span class='hs-varid'>stack</span>
<a name="line-981"></a>
<a name="line-982"></a><a name="Continuation"></a><span class='hs-comment'>-- | A local continuation for loop constructs</span>
<a name="line-983"></a><a name="Continuation"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>Continuation</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Continuation</span> <span class='hs-layout'>(</span><span class='hs-conid'>()</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span>
<a name="line-984"></a>
<a name="line-985"></a><a name="instance%20Sizeable%20Continuation"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Sizeable</span> <span class='hs-conid'>Continuation</span> <span class='hs-keyword'>where</span>
<a name="line-986"></a>  <span class='hs-varid'>storageBytes</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>storageBytes</span> <span class='hs-conid'>()</span>
<a name="line-987"></a>
<a name="line-988"></a><a name="Context"></a><span class='hs-comment'>-- | A structure describing a (possibly nested) context for the current frame,</span>
<a name="line-989"></a><a name="Context"></a><span class='hs-comment'>-- used to manage loop break/continue and try/finally interactions</span>
<a name="line-990"></a><a name="Context"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Context</span> <span class='hs-keyglyph'>=</span>
<a name="line-991"></a>  <span class='hs-conid'>Loop</span> <span class='hs-layout'>{</span>
<a name="line-992"></a>    <span class='hs-varid'>loopName</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span>
<a name="line-993"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>loopBreak</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Continuation</span>
<a name="line-994"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>loopContinue</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Continuation</span>
<a name="line-995"></a>  <span class='hs-layout'>}</span> <span class='hs-keyglyph'>|</span>
<a name="line-996"></a>  <span class='hs-conid'>TryFinally</span> <span class='hs-layout'>{</span>
<a name="line-997"></a>    <span class='hs-varid'>finally</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-998"></a>  <span class='hs-layout'>}</span>
<a name="line-999"></a>
<a name="line-1000"></a><a name="instance%20Sizeable%20Context"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Sizeable</span> <span class='hs-conid'>Context</span> <span class='hs-keyword'>where</span>
<a name="line-1001"></a>  <span class='hs-varid'>storageBytes</span> <span class='hs-varid'>context</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Loop</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-1002"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>loopName</span>     <span class='hs-varid'>context</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1003"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>loopBreak</span>    <span class='hs-varid'>context</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1004"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>loopContinue</span> <span class='hs-varid'>context</span><span class='hs-layout'>)</span>
<a name="line-1005"></a>  <span class='hs-varid'>storageBytes</span> <span class='hs-conid'>TryFinally</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>storageBytes</span> <span class='hs-conid'>()</span>
<a name="line-1006"></a>    <span class='hs-comment'>-- storageBytes (finally context)</span>
<a name="line-1007"></a>
<a name="line-1008"></a><a name="instance%20Show%20Context"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>Context</span> <span class='hs-keyword'>where</span>
<a name="line-1009"></a>  <span class='hs-varid'>show</span> <span class='hs-conid'>Loop</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loopName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>   <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"&lt;Loop&gt;"</span>
<a name="line-1010"></a>  <span class='hs-varid'>show</span> <span class='hs-conid'>Loop</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loopName</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"&lt;Loop "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>name</span> <span class='hs-varop'>++</span> <span class='hs-str'>"&gt;"</span>
<a name="line-1011"></a>
<a name="line-1012"></a>  <span class='hs-varid'>show</span> <span class='hs-conid'>TryFinally</span><span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"&lt;TryFinally&gt;"</span>
<a name="line-1013"></a>
<a name="line-1014"></a><a name="StackFrame"></a><span class='hs-comment'>-- | The data tracked for each verb and/or built-in function call</span>
<a name="line-1015"></a><a name="StackFrame"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>StackFrame</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Frame</span> <span class='hs-layout'>{</span>
<a name="line-1016"></a>    <span class='hs-varid'>depthLeft</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-1017"></a>
<a name="line-1018"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>contextStack</span>  <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Context</span><span class='hs-keyglyph'>]</span>
<a name="line-1019"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>variables</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Id</span> <span class='hs-conid'>Value</span>
<a name="line-1020"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>debugBit</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-1021"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>permissions</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span>
<a name="line-1022"></a>
<a name="line-1023"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>verbName</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrT</span>
<a name="line-1024"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>verbFullName</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrT</span>
<a name="line-1025"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>verbLocation</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span>
<a name="line-1026"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>initialThis</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span>
<a name="line-1027"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>initialPlayer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span>
<a name="line-1028"></a>
<a name="line-1029"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>builtinFunc</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-1030"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>lineNumber</span>    <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IntT</span>
<a name="line-1031"></a>  <span class='hs-layout'>}</span> <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Show</span>
<a name="line-1032"></a>
<a name="line-1033"></a><a name="initFrame"></a><span class='hs-definition'>initFrame</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Frame</span> <span class='hs-layout'>{</span>
<a name="line-1034"></a>    <span class='hs-varid'>depthLeft</span>     <span class='hs-keyglyph'>=</span> <span class='hs-num'>50</span>
<a name="line-1035"></a>
<a name="line-1036"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>contextStack</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-1037"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>variables</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initVariables</span>
<a name="line-1038"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>debugBit</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1039"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>permissions</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nothing</span>
<a name="line-1040"></a>
<a name="line-1041"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>verbName</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-1042"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>verbFullName</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-1043"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>verbLocation</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nothing</span>
<a name="line-1044"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>initialThis</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nothing</span>
<a name="line-1045"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>initialPlayer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nothing</span>
<a name="line-1046"></a>
<a name="line-1047"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>builtinFunc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1048"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>lineNumber</span>    <span class='hs-keyglyph'>=</span> <span class='hs-num'>0</span>
<a name="line-1049"></a>  <span class='hs-layout'>}</span>
<a name="line-1050"></a>
<a name="line-1051"></a><a name="instance%20Sizeable%20StackFrame"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Sizeable</span> <span class='hs-conid'>StackFrame</span> <span class='hs-keyword'>where</span>
<a name="line-1052"></a>  <span class='hs-varid'>storageBytes</span> <span class='hs-varid'>frame</span> <span class='hs-keyglyph'>=</span>
<a name="line-1053"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>depthLeft</span>     <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1054"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>contextStack</span>  <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1055"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>variables</span>     <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1056"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>debugBit</span>      <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1057"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>permissions</span>   <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1058"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbName</span>      <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1059"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbFullName</span>  <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1060"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbLocation</span>  <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1061"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>initialThis</span>   <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1062"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>initialPlayer</span> <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1063"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>builtinFunc</span>   <span class='hs-varid'>frame</span><span class='hs-layout'>)</span> <span class='hs-varop'>+</span>
<a name="line-1064"></a>    <span class='hs-varid'>storageBytes</span> <span class='hs-layout'>(</span><span class='hs-varid'>lineNumber</span>    <span class='hs-varid'>frame</span><span class='hs-layout'>)</span>
<a name="line-1065"></a>
<a name="line-1066"></a><a name="formatFrames"></a><span class='hs-definition'>formatFrames</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StackFrame</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Value</span>
<a name="line-1067"></a><span class='hs-definition'>formatFrames</span> <span class='hs-varid'>includeLineNumbers</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromListBy</span> <span class='hs-varid'>formatFrame</span>
<a name="line-1068"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>formatFrame</span> <span class='hs-varid'>frame</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span>
<a name="line-1069"></a>                              <span class='hs-conid'>Obj</span> <span class='hs-layout'>(</span><span class='hs-varid'>initialThis</span>   <span class='hs-varid'>frame</span><span class='hs-layout'>)</span>
<a name="line-1070"></a>                            <span class='hs-conop'>:</span> <span class='hs-conid'>Str</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbName</span>      <span class='hs-varid'>frame</span><span class='hs-layout'>)</span>
<a name="line-1071"></a>                            <span class='hs-conop'>:</span> <span class='hs-conid'>Obj</span> <span class='hs-layout'>(</span><span class='hs-varid'>permissions</span>   <span class='hs-varid'>frame</span><span class='hs-layout'>)</span>
<a name="line-1072"></a>                            <span class='hs-conop'>:</span> <span class='hs-conid'>Obj</span> <span class='hs-layout'>(</span><span class='hs-varid'>verbLocation</span>  <span class='hs-varid'>frame</span><span class='hs-layout'>)</span>
<a name="line-1073"></a>                            <span class='hs-conop'>:</span> <span class='hs-conid'>Obj</span> <span class='hs-layout'>(</span><span class='hs-varid'>initialPlayer</span> <span class='hs-varid'>frame</span><span class='hs-layout'>)</span>
<a name="line-1074"></a>                            <span class='hs-conop'>:</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Int</span> <span class='hs-varop'>$</span> <span class='hs-varid'>lineNumber</span> <span class='hs-varid'>frame</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>includeLineNumbers</span><span class='hs-keyglyph'>]</span>
<a name="line-1075"></a>
<a name="line-1076"></a><a name="pushFrame"></a><span class='hs-definition'>pushFrame</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StackFrame</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1077"></a><span class='hs-definition'>pushFrame</span> <span class='hs-varid'>frame</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modify</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>state</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>State</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-varid'>frames</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1078"></a>  <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-layout'>(</span><span class='hs-varid'>frame</span> <span class='hs-conop'>:</span> <span class='hs-varid'>frames</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1079"></a>
<a name="line-1080"></a><a name="popFrame"></a><span class='hs-definition'>popFrame</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1081"></a><span class='hs-definition'>popFrame</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1082"></a>  <span class='hs-varid'>unwindContexts</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-1083"></a>  <span class='hs-varid'>modify</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>state</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>State</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>frames</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1084"></a>    <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-varid'>frames</span> <span class='hs-layout'>}</span>
<a name="line-1085"></a>
<a name="line-1086"></a><a name="currentFrame"></a><span class='hs-definition'>currentFrame</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackFrame</span>
<a name="line-1087"></a><span class='hs-definition'>currentFrame</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stack</span> <span class='hs-layout'>(</span><span class='hs-varid'>frame</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>frame</span>
<a name="line-1088"></a><span class='hs-definition'>currentFrame</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stack</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"currentFrame: Empty call stack"</span>
<a name="line-1089"></a>
<a name="line-1090"></a><a name="previousFrame"></a><span class='hs-definition'>previousFrame</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>StackFrame</span>
<a name="line-1091"></a><span class='hs-definition'>previousFrame</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stack</span> <span class='hs-layout'>(</span><span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>frames</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>previousFrame'</span> <span class='hs-varid'>frames</span>
<a name="line-1092"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>previousFrame'</span> <span class='hs-layout'>(</span><span class='hs-varid'>frame</span><span class='hs-conop'>:</span><span class='hs-varid'>frames</span><span class='hs-layout'>)</span>
<a name="line-1093"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>builtinFunc</span> <span class='hs-varid'>frame</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>previousFrame'</span> <span class='hs-varid'>frames</span>
<a name="line-1094"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>         <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>frame</span>
<a name="line-1095"></a>        <span class='hs-varid'>previousFrame'</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-1096"></a><span class='hs-definition'>previousFrame</span> <span class='hs-layout'>(</span><span class='hs-conid'>Stack</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>error</span> <span class='hs-str'>"previousFrame: Empty call stack"</span>
<a name="line-1097"></a>
<a name="line-1098"></a><a name="activeFrame"></a><span class='hs-definition'>activeFrame</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Task</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackFrame</span>
<a name="line-1099"></a><span class='hs-definition'>activeFrame</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>currentFrame</span> <span class='hs-varop'>.</span> <span class='hs-varid'>stack</span> <span class='hs-varop'>.</span> <span class='hs-varid'>taskState</span>
<a name="line-1100"></a>
<a name="line-1101"></a><a name="frame"></a><span class='hs-definition'>frame</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>StackFrame</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-1102"></a><span class='hs-definition'>frame</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gets</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varop'>.</span> <span class='hs-varid'>currentFrame</span> <span class='hs-varop'>.</span> <span class='hs-varid'>stack</span><span class='hs-layout'>)</span>
<a name="line-1103"></a>
<a name="line-1104"></a><a name="caller"></a><span class='hs-definition'>caller</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>StackFrame</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-1105"></a><span class='hs-definition'>caller</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gets</span> <span class='hs-layout'>(</span><span class='hs-varid'>fmap</span> <span class='hs-varid'>f</span> <span class='hs-varop'>.</span> <span class='hs-varid'>previousFrame</span> <span class='hs-varop'>.</span> <span class='hs-varid'>stack</span><span class='hs-layout'>)</span>
<a name="line-1106"></a>
<a name="line-1107"></a><a name="modifyFrame"></a><span class='hs-definition'>modifyFrame</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>StackFrame</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StackFrame</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1108"></a><span class='hs-definition'>modifyFrame</span> <span class='hs-varid'>f</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modify</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>state</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>State</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-layout'>(</span><span class='hs-varid'>frame</span><span class='hs-conop'>:</span><span class='hs-varid'>stack</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1109"></a>  <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-varid'>frame</span> <span class='hs-conop'>:</span> <span class='hs-varid'>stack</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-1110"></a>
<a name="line-1111"></a><a name="setLineNumber"></a><span class='hs-definition'>setLineNumber</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1112"></a><span class='hs-definition'>setLineNumber</span> <span class='hs-varid'>lineNumber</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyFrame</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>frame</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1113"></a>  <span class='hs-varid'>frame</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lineNumber</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromIntegral</span> <span class='hs-varid'>lineNumber</span> <span class='hs-layout'>}</span>
<a name="line-1114"></a>
<a name="line-1115"></a><a name="pushContext"></a><span class='hs-definition'>pushContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Context</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1116"></a><span class='hs-definition'>pushContext</span> <span class='hs-varid'>context</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyFrame</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>frame</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1117"></a>  <span class='hs-varid'>frame</span> <span class='hs-layout'>{</span> <span class='hs-varid'>contextStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>context</span> <span class='hs-conop'>:</span> <span class='hs-varid'>contextStack</span> <span class='hs-varid'>frame</span> <span class='hs-layout'>}</span>
<a name="line-1118"></a>
<a name="line-1119"></a><a name="pushTryFinallyContext"></a><span class='hs-definition'>pushTryFinallyContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1120"></a><span class='hs-definition'>pushTryFinallyContext</span> <span class='hs-varid'>finally</span> <span class='hs-keyglyph'>=</span>
<a name="line-1121"></a>  <span class='hs-varid'>pushContext</span> <span class='hs-conid'>TryFinally</span> <span class='hs-layout'>{</span> <span class='hs-varid'>finally</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finally</span> <span class='hs-layout'>}</span>
<a name="line-1122"></a>
<a name="line-1123"></a><a name="pushLoopContext"></a><span class='hs-definition'>pushLoopContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Continuation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1124"></a><span class='hs-definition'>pushLoopContext</span> <span class='hs-varid'>name</span> <span class='hs-varid'>break</span> <span class='hs-keyglyph'>=</span>
<a name="line-1125"></a>  <span class='hs-varid'>pushContext</span> <span class='hs-conid'>Loop</span> <span class='hs-layout'>{</span>
<a name="line-1126"></a>      <span class='hs-varid'>loopName</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-1127"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>loopBreak</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>break</span>
<a name="line-1128"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>loopContinue</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>undefined</span>
<a name="line-1129"></a>  <span class='hs-layout'>}</span>
<a name="line-1130"></a>
<a name="line-1131"></a><a name="setLoopContinue"></a><span class='hs-definition'>setLoopContinue</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Continuation</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1132"></a><span class='hs-definition'>setLoopContinue</span> <span class='hs-varid'>continue</span> <span class='hs-keyglyph'>=</span>
<a name="line-1133"></a>  <span class='hs-varid'>modifyFrame</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>frame</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Frame</span> <span class='hs-layout'>{</span> <span class='hs-varid'>contextStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loop</span><span class='hs-conop'>:</span><span class='hs-varid'>loops</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1134"></a>    <span class='hs-varid'>frame</span> <span class='hs-layout'>{</span> <span class='hs-varid'>contextStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loop</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loopContinue</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>continue</span> <span class='hs-layout'>}</span> <span class='hs-conop'>:</span> <span class='hs-varid'>loops</span> <span class='hs-layout'>}</span>
<a name="line-1135"></a>
<a name="line-1136"></a><a name="popContext"></a><span class='hs-definition'>popContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1137"></a><span class='hs-definition'>popContext</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>modifyFrame</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>frame</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Frame</span> <span class='hs-layout'>{</span> <span class='hs-varid'>contextStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>_</span><span class='hs-conop'>:</span><span class='hs-varid'>contexts</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1138"></a>  <span class='hs-varid'>frame</span> <span class='hs-layout'>{</span> <span class='hs-varid'>contextStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>contexts</span> <span class='hs-layout'>}</span>
<a name="line-1139"></a>
<a name="line-1140"></a><a name="unwindContexts"></a><span class='hs-definition'>unwindContexts</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Context</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Context</span><span class='hs-keyglyph'>]</span>
<a name="line-1141"></a><span class='hs-definition'>unwindContexts</span> <span class='hs-varid'>p</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1142"></a>  <span class='hs-varid'>stack</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unwind</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>frame</span> <span class='hs-varid'>contextStack</span>
<a name="line-1143"></a>  <span class='hs-varid'>modifyFrame</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>frame</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>frame</span> <span class='hs-layout'>{</span> <span class='hs-varid'>contextStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>stack</span> <span class='hs-layout'>}</span>
<a name="line-1144"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>stack</span>
<a name="line-1145"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>unwind</span> <span class='hs-varid'>stack</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>this</span><span class='hs-conop'>:</span><span class='hs-varid'>next</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-1146"></a>          <span class='hs-keyword'>if</span> <span class='hs-varid'>p</span> <span class='hs-varid'>this</span>
<a name="line-1147"></a>          <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>stack</span>
<a name="line-1148"></a>          <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-1149"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>this</span> <span class='hs-keyword'>of</span>
<a name="line-1150"></a>              <span class='hs-conid'>TryFinally</span> <span class='hs-layout'>{</span> <span class='hs-varid'>finally</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>finally</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-1151"></a>                <span class='hs-varid'>modifyFrame</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>frame</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>frame</span> <span class='hs-layout'>{</span> <span class='hs-varid'>contextStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>next</span> <span class='hs-layout'>}</span>
<a name="line-1152"></a>                <span class='hs-varid'>void</span> <span class='hs-varid'>finally</span>
<a name="line-1153"></a>              <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1154"></a>            <span class='hs-varid'>unwind</span> <span class='hs-varid'>next</span>
<a name="line-1155"></a>        <span class='hs-varid'>unwind</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>[]</span>
<a name="line-1156"></a>
<a name="line-1157"></a><a name="unwindLoopContext"></a><span class='hs-definition'>unwindLoopContext</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Context</span>
<a name="line-1158"></a><span class='hs-definition'>unwindLoopContext</span> <span class='hs-varid'>maybeName</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1159"></a>  <span class='hs-varid'>loop</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unwindContexts</span> <span class='hs-varid'>testContext</span>
<a name="line-1160"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>loop</span>
<a name="line-1161"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>testContext</span> <span class='hs-conid'>Loop</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loopName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-1162"></a>          <span class='hs-varid'>isNothing</span> <span class='hs-varid'>maybeName</span> <span class='hs-varop'>||</span> <span class='hs-varid'>maybeName</span> <span class='hs-varop'>==</span> <span class='hs-varid'>name</span>
<a name="line-1163"></a>        <span class='hs-varid'>testContext</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1164"></a>
<a name="line-1165"></a><a name="breakLoop"></a><span class='hs-definition'>breakLoop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-1166"></a><span class='hs-definition'>breakLoop</span> <span class='hs-varid'>maybeName</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1167"></a>  <span class='hs-conid'>Loop</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loopBreak</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Continuation</span> <span class='hs-varid'>break</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unwindLoopContext</span> <span class='hs-varid'>maybeName</span>
<a name="line-1168"></a>  <span class='hs-varid'>break</span> <span class='hs-conid'>()</span>
<a name="line-1169"></a>
<a name="line-1170"></a><a name="continueLoop"></a><span class='hs-definition'>continueLoop</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>Id</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-1171"></a><span class='hs-definition'>continueLoop</span> <span class='hs-varid'>maybeName</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1172"></a>  <span class='hs-conid'>Loop</span> <span class='hs-layout'>{</span> <span class='hs-varid'>loopContinue</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Continuation</span> <span class='hs-varid'>continue</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>unwindLoopContext</span> <span class='hs-varid'>maybeName</span>
<a name="line-1173"></a>  <span class='hs-varid'>continue</span> <span class='hs-conid'>()</span>
<a name="line-1174"></a>
<a name="line-1175"></a><a name="initVariables"></a><span class='hs-comment'>-- | The default collection of verb variables</span>
<a name="line-1176"></a><span class='hs-definition'>initVariables</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Id</span> <span class='hs-conid'>Value</span>
<a name="line-1177"></a><span class='hs-definition'>initVariables</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>[</span>
<a name="line-1178"></a>    <span class='hs-layout'>(</span><span class='hs-str'>"player"</span> <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>nothing</span><span class='hs-layout'>)</span>
<a name="line-1179"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"this"</span>   <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>nothing</span><span class='hs-layout'>)</span>
<a name="line-1180"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"caller"</span> <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>nothing</span><span class='hs-layout'>)</span>
<a name="line-1181"></a>
<a name="line-1182"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"args"</span>   <span class='hs-layout'>,</span> <span class='hs-varid'>emptyList</span><span class='hs-layout'>)</span>
<a name="line-1183"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"argstr"</span> <span class='hs-layout'>,</span> <span class='hs-varid'>emptyString</span><span class='hs-layout'>)</span>
<a name="line-1184"></a>
<a name="line-1185"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"verb"</span>   <span class='hs-layout'>,</span> <span class='hs-varid'>emptyString</span><span class='hs-layout'>)</span>
<a name="line-1186"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"dobjstr"</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyString</span><span class='hs-layout'>)</span>
<a name="line-1187"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"dobj"</span>   <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>nothing</span><span class='hs-layout'>)</span>
<a name="line-1188"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"prepstr"</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyString</span><span class='hs-layout'>)</span>
<a name="line-1189"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"iobjstr"</span><span class='hs-layout'>,</span> <span class='hs-varid'>emptyString</span><span class='hs-layout'>)</span>
<a name="line-1190"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"iobj"</span>   <span class='hs-layout'>,</span> <span class='hs-conid'>Obj</span> <span class='hs-varid'>nothing</span><span class='hs-layout'>)</span>
<a name="line-1191"></a>  <span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span> <span class='hs-varid'>typeVariables</span>
<a name="line-1192"></a>
<a name="line-1193"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>typeVariables</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span>
<a name="line-1194"></a>            <span class='hs-layout'>(</span><span class='hs-str'>"INT"</span>  <span class='hs-layout'>,</span> <span class='hs-conid'>Int</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeCode</span> <span class='hs-conid'>TInt</span><span class='hs-layout'>)</span>
<a name="line-1195"></a>          <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"NUM"</span>  <span class='hs-layout'>,</span> <span class='hs-conid'>Int</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeCode</span> <span class='hs-conid'>TInt</span><span class='hs-layout'>)</span>
<a name="line-1196"></a>          <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"FLOAT"</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeCode</span> <span class='hs-conid'>TFlt</span><span class='hs-layout'>)</span>
<a name="line-1197"></a>          <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"LIST"</span> <span class='hs-layout'>,</span> <span class='hs-conid'>Int</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeCode</span> <span class='hs-conid'>TLst</span><span class='hs-layout'>)</span>
<a name="line-1198"></a>          <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"STR"</span>  <span class='hs-layout'>,</span> <span class='hs-conid'>Int</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeCode</span> <span class='hs-conid'>TStr</span><span class='hs-layout'>)</span>
<a name="line-1199"></a>          <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"OBJ"</span>  <span class='hs-layout'>,</span> <span class='hs-conid'>Int</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeCode</span> <span class='hs-conid'>TObj</span><span class='hs-layout'>)</span>
<a name="line-1200"></a>          <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"ERR"</span>  <span class='hs-layout'>,</span> <span class='hs-conid'>Int</span> <span class='hs-varop'>$</span> <span class='hs-varid'>typeCode</span> <span class='hs-conid'>TErr</span><span class='hs-layout'>)</span>
<a name="line-1201"></a>          <span class='hs-keyglyph'>]</span>
<a name="line-1202"></a>
<a name="line-1203"></a><a name="mkVariables"></a><span class='hs-comment'>-- | Create a variable block for a verb by overriding the default.</span>
<a name="line-1204"></a><span class='hs-definition'>mkVariables</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Id</span><span class='hs-layout'>,</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Map</span> <span class='hs-conid'>Id</span> <span class='hs-conid'>Value</span>
<a name="line-1205"></a><span class='hs-definition'>mkVariables</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>uncurry</span> <span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>insert</span><span class='hs-layout'>)</span> <span class='hs-varid'>initVariables</span>
<a name="line-1206"></a>
<a name="line-1207"></a><a name="ExceptionHandler"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>ExceptionHandler</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Handler</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exception</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span><span class='hs-layout'>)</span>
<a name="line-1208"></a>
<a name="line-1209"></a><a name="instance%20Show%20ExceptionHandler"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>ExceptionHandler</span> <span class='hs-keyword'>where</span>
<a name="line-1210"></a>  <span class='hs-varid'>show</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"&lt;ExceptionHandler&gt;"</span>
<a name="line-1211"></a>
<a name="line-1212"></a><a name="Exception"></a><span class='hs-comment'>-- | A MOO exception</span>
<a name="line-1213"></a><a name="Exception"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Exception</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Exception</span> <span class='hs-layout'>{</span>
<a name="line-1214"></a>    <span class='hs-varid'>exceptionCode</span>      <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span>
<a name="line-1215"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionMessage</span>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Message</span>
<a name="line-1216"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionValue</span>     <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Value</span>
<a name="line-1217"></a>
<a name="line-1218"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionCallStack</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CallStack</span>
<a name="line-1219"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionDebugBit</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>
<a name="line-1220"></a>    <span class='hs-comment'>-- ^ A copy of the debug bit from the verb frame in which the exception</span>
<a name="line-1221"></a>    <span class='hs-comment'>-- was raised</span>
<a name="line-1222"></a>  <span class='hs-layout'>}</span>
<a name="line-1223"></a>
<a name="line-1224"></a><a name="Code"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Code</span>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Value</span>
<a name="line-1225"></a><a name="Message"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Message</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>StrT</span>
<a name="line-1226"></a>
<a name="line-1227"></a><a name="initException"></a><span class='hs-definition'>initException</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Exception</span> <span class='hs-layout'>{</span>
<a name="line-1228"></a>    <span class='hs-varid'>exceptionCode</span>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Err</span> <span class='hs-conid'>E_NONE</span>
<a name="line-1229"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionMessage</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>fromText</span> <span class='hs-layout'>(</span><span class='hs-varid'>error2text</span> <span class='hs-conid'>E_NONE</span><span class='hs-layout'>)</span>
<a name="line-1230"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionValue</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>zero</span>
<a name="line-1231"></a>
<a name="line-1232"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionCallStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-conid'>[]</span>
<a name="line-1233"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionDebugBit</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-1234"></a>  <span class='hs-layout'>}</span>
<a name="line-1235"></a>
<a name="line-1236"></a><a name="newException"></a><span class='hs-definition'>newException</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Message</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Exception</span>
<a name="line-1237"></a><span class='hs-definition'>newException</span> <span class='hs-varid'>code</span> <span class='hs-varid'>message</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>initException</span> <span class='hs-layout'>{</span>
<a name="line-1238"></a>    <span class='hs-varid'>exceptionCode</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>code</span>
<a name="line-1239"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionMessage</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>message</span>
<a name="line-1240"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionValue</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>value</span>
<a name="line-1241"></a>  <span class='hs-layout'>}</span>
<a name="line-1242"></a>
<a name="line-1243"></a><a name="catchException"></a><span class='hs-comment'>-- | Install a local exception handler for the duration of the passed</span>
<a name="line-1244"></a><span class='hs-comment'>-- computation.</span>
<a name="line-1245"></a><span class='hs-definition'>catchException</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Exception</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-1246"></a><span class='hs-definition'>catchException</span> <span class='hs-varid'>action</span> <span class='hs-varid'>handler</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callCC</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>k</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>local</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkHandler</span> <span class='hs-varid'>k</span><span class='hs-layout'>)</span> <span class='hs-varid'>action</span>
<a name="line-1247"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>mkHandler</span> <span class='hs-varid'>k</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env</span> <span class='hs-layout'>{</span> <span class='hs-varid'>exceptionHandler</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Handler</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-1248"></a>                                 <span class='hs-varid'>local</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>e</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>k</span> <span class='hs-layout'>}</span>
<a name="line-1249"></a>
<a name="line-1250"></a><a name="passException"></a><span class='hs-comment'>-- | Re-raise an exception to the next enclosing handler.</span>
<a name="line-1251"></a><span class='hs-definition'>passException</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exception</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-1252"></a><span class='hs-definition'>passException</span> <span class='hs-varid'>except</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1253"></a>  <span class='hs-conid'>Handler</span> <span class='hs-varid'>handler</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>asks</span> <span class='hs-varid'>exceptionHandler</span>
<a name="line-1254"></a>  <span class='hs-varid'>handler</span> <span class='hs-varid'>except</span>
<a name="line-1255"></a>  <span class='hs-varid'>error</span> <span class='hs-str'>"Returned from exception handler"</span>
<a name="line-1256"></a>
<a name="line-1257"></a><a name="raiseException"></a><span class='hs-comment'>-- | Abort execution of the current computation and call the nearest enclosing</span>
<a name="line-1258"></a><span class='hs-comment'>-- exception handler.</span>
<a name="line-1259"></a><span class='hs-definition'>raiseException</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Code</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Message</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-1260"></a><span class='hs-definition'>raiseException</span> <span class='hs-varid'>code</span> <span class='hs-varid'>message</span> <span class='hs-varid'>value</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1261"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>except</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>newException</span> <span class='hs-varid'>code</span> <span class='hs-varid'>message</span> <span class='hs-varid'>value</span>
<a name="line-1262"></a>  <span class='hs-varid'>callStack</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>stack</span>
<a name="line-1263"></a>  <span class='hs-varid'>debug</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>frame</span> <span class='hs-varid'>debugBit</span>
<a name="line-1264"></a>  <span class='hs-varid'>passException</span> <span class='hs-varid'>except</span> <span class='hs-layout'>{</span>
<a name="line-1265"></a>      <span class='hs-varid'>exceptionCallStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>callStack</span>
<a name="line-1266"></a>    <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionDebugBit</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>debug</span>
<a name="line-1267"></a>    <span class='hs-layout'>}</span>
<a name="line-1268"></a>
<a name="line-1269"></a><a name="handleDebug"></a><span class='hs-comment'>-- | Execute the passed computation, capturing any exception raised in verb</span>
<a name="line-1270"></a><span class='hs-comment'>-- frames with debug bit unset and returning the error code as an ordinary</span>
<a name="line-1271"></a><span class='hs-comment'>-- value instead of propagating the exception.</span>
<a name="line-1272"></a><span class='hs-definition'>handleDebug</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-1273"></a><span class='hs-definition'>handleDebug</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varop'>`catchException`</span> <span class='hs-varid'>handler</span><span class='hs-layout'>)</span>
<a name="line-1274"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>handler</span> <span class='hs-conid'>Exception</span> <span class='hs-layout'>{</span>
<a name="line-1275"></a>            <span class='hs-varid'>exceptionDebugBit</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1276"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>exceptionCode</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>code</span>
<a name="line-1277"></a>          <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>code</span>
<a name="line-1278"></a>        <span class='hs-varid'>handler</span> <span class='hs-varid'>except</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>passException</span> <span class='hs-varid'>except</span>
<a name="line-1279"></a>
<a name="line-1280"></a><a name="notyet"></a><span class='hs-comment'>-- | Placeholder for features not yet implemented</span>
<a name="line-1281"></a><span class='hs-definition'>notyet</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-1282"></a><span class='hs-definition'>notyet</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>raiseException</span> <span class='hs-layout'>(</span><span class='hs-conid'>Err</span> <span class='hs-conid'>E_QUOTA</span><span class='hs-layout'>)</span> <span class='hs-str'>"Not yet implemented"</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Str</span>
<a name="line-1283"></a>
<a name="line-1284"></a><a name="raise"></a><span class='hs-comment'>-- | Create and raise an exception for the given MOO error.</span>
<a name="line-1285"></a><span class='hs-definition'>raise</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Error</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-1286"></a><span class='hs-definition'>raise</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>raiseException</span> <span class='hs-layout'>(</span><span class='hs-conid'>Err</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>fromText</span> <span class='hs-varop'>$</span> <span class='hs-varid'>error2text</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-varid'>zero</span>
<a name="line-1287"></a>
<a name="line-1288"></a><a name="checkFloat"></a><span class='hs-comment'>-- | Verify that the given floating point number is neither infinite nor NaN,</span>
<a name="line-1289"></a><span class='hs-comment'>-- raising 'E_FLOAT' or 'E_INVARG' respectively if so. Also, return the</span>
<a name="line-1290"></a><span class='hs-comment'>-- corresponding MOO value.</span>
<a name="line-1291"></a><span class='hs-definition'>checkFloat</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FltT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Value</span>
<a name="line-1292"></a><span class='hs-definition'>checkFloat</span> <span class='hs-varid'>flt</span>
<a name="line-1293"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isInfinite</span> <span class='hs-varid'>flt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_FLOAT</span>
<a name="line-1294"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNaN</span>      <span class='hs-varid'>flt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_INVARG</span>
<a name="line-1295"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Flt</span> <span class='hs-varid'>flt</span><span class='hs-layout'>)</span>
<a name="line-1296"></a>
<a name="line-1297"></a><a name="checkProgrammer'"></a><span class='hs-comment'>-- | Verify that the given object has a programmer bit, raising 'E_PERM' if</span>
<a name="line-1298"></a><span class='hs-comment'>-- not.</span>
<a name="line-1299"></a><span class='hs-definition'>checkProgrammer'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1300"></a><span class='hs-definition'>checkProgrammer'</span> <span class='hs-varid'>perm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1301"></a>  <span class='hs-varid'>programmer</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>maybe</span> <span class='hs-conid'>False</span> <span class='hs-varid'>objectProgrammer</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>getObject</span> <span class='hs-varid'>perm</span>
<a name="line-1302"></a>  <span class='hs-varid'>unless</span> <span class='hs-varid'>programmer</span> <span class='hs-varop'>$</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_PERM</span>
<a name="line-1303"></a>
<a name="line-1304"></a><a name="checkProgrammer"></a><span class='hs-comment'>-- | Verify that the current task permissions have programmer privileges,</span>
<a name="line-1305"></a><span class='hs-comment'>-- raising 'E_PERM' if not.</span>
<a name="line-1306"></a><span class='hs-definition'>checkProgrammer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1307"></a><span class='hs-definition'>checkProgrammer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkProgrammer'</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>frame</span> <span class='hs-varid'>permissions</span>
<a name="line-1308"></a>
<a name="line-1309"></a><a name="isWizard"></a><span class='hs-comment'>-- | Determine whether the given object has its wizard bit set.</span>
<a name="line-1310"></a><span class='hs-definition'>isWizard</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Bool</span>
<a name="line-1311"></a><span class='hs-definition'>isWizard</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-varid'>maybe</span> <span class='hs-conid'>False</span> <span class='hs-varid'>objectWizard</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getObject</span>
<a name="line-1312"></a>
<a name="line-1313"></a><a name="checkWizard'"></a><span class='hs-comment'>-- | Verify that the given object is a wizard, raising 'E_PERM' if not.</span>
<a name="line-1314"></a><span class='hs-definition'>checkWizard'</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1315"></a><span class='hs-definition'>checkWizard'</span> <span class='hs-varid'>perm</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1316"></a>  <span class='hs-varid'>wizard</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>isWizard</span> <span class='hs-varid'>perm</span>
<a name="line-1317"></a>  <span class='hs-varid'>unless</span> <span class='hs-varid'>wizard</span> <span class='hs-varop'>$</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_PERM</span>
<a name="line-1318"></a>
<a name="line-1319"></a><a name="checkWizard"></a><span class='hs-comment'>-- | Verify that the current task permissions have wizard privileges, raising</span>
<a name="line-1320"></a><span class='hs-comment'>-- 'E_PERM' if not.</span>
<a name="line-1321"></a><span class='hs-definition'>checkWizard</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1322"></a><span class='hs-definition'>checkWizard</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkWizard'</span> <span class='hs-varop'>=&lt;&lt;</span> <span class='hs-varid'>frame</span> <span class='hs-varid'>permissions</span>
<a name="line-1323"></a>
<a name="line-1324"></a><a name="checkPermission"></a><span class='hs-comment'>-- | Verify that the current task permissions either have wizard privileges or</span>
<a name="line-1325"></a><span class='hs-comment'>-- are the same as the given object, raising 'E_PERM' if not.</span>
<a name="line-1326"></a><span class='hs-definition'>checkPermission</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1327"></a><span class='hs-definition'>checkPermission</span> <span class='hs-varid'>who</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1328"></a>  <span class='hs-varid'>perm</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>frame</span> <span class='hs-varid'>permissions</span>
<a name="line-1329"></a>  <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>perm</span> <span class='hs-varop'>==</span> <span class='hs-varid'>who</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>checkWizard'</span> <span class='hs-varid'>perm</span>
<a name="line-1330"></a>
<a name="line-1331"></a><a name="checkValid"></a><span class='hs-comment'>-- | Verify that the given object is valid, raising 'E_INVARG' if not. Also,</span>
<a name="line-1332"></a><span class='hs-comment'>-- return the referenced object.</span>
<a name="line-1333"></a><span class='hs-definition'>checkValid</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>Object</span>
<a name="line-1334"></a><span class='hs-definition'>checkValid</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getObject</span> <span class='hs-varop'>&gt;=&gt;</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>raise</span> <span class='hs-conid'>E_INVARG</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span>
<a name="line-1335"></a>
<a name="line-1336"></a><a name="checkFertile"></a><span class='hs-comment'>-- | Verify that the given object is fertile for the current task permissions,</span>
<a name="line-1337"></a><span class='hs-comment'>-- raising 'E_PERM' if not.</span>
<a name="line-1338"></a><span class='hs-definition'>checkFertile</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ObjId</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1339"></a><span class='hs-definition'>checkFertile</span> <span class='hs-varid'>oid</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1340"></a>  <span class='hs-varid'>maybeObj</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getObject</span> <span class='hs-varid'>oid</span>
<a name="line-1341"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>maybeObj</span> <span class='hs-keyword'>of</span>
<a name="line-1342"></a>    <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_PERM</span>
<a name="line-1343"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>obj</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>unless</span> <span class='hs-layout'>(</span><span class='hs-varid'>objectPermF</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>checkPermission</span> <span class='hs-layout'>(</span><span class='hs-varid'>objectOwner</span> <span class='hs-varid'>obj</span><span class='hs-layout'>)</span>
<a name="line-1344"></a>
<a name="line-1345"></a><a name="checkRecurrence"></a><span class='hs-comment'>-- | Verify that the given /object/ does not have a recursive relationship</span>
<a name="line-1346"></a><span class='hs-comment'>-- with the given /subject/, raising 'E_RECMOVE' if so.</span>
<a name="line-1347"></a><span class='hs-definition'>checkRecurrence</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Object</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>ObjId</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- ^ relationship projection</span>
<a name="line-1348"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ObjId</span>                    <span class='hs-comment'>-- ^ /subject/</span>
<a name="line-1349"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ObjId</span>                    <span class='hs-comment'>-- ^ /object/ to check</span>
<a name="line-1350"></a>                <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1351"></a><span class='hs-definition'>checkRecurrence</span> <span class='hs-varid'>relation</span> <span class='hs-varid'>subject</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>checkRecurrence'</span>
<a name="line-1352"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>checkRecurrence'</span> <span class='hs-varid'>object</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1353"></a>          <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>object</span> <span class='hs-varop'>==</span> <span class='hs-varid'>subject</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>raise</span> <span class='hs-conid'>E_RECMOVE</span>
<a name="line-1354"></a>          <span class='hs-varid'>maybeObject</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getObject</span> <span class='hs-varid'>object</span>
<a name="line-1355"></a>          <span class='hs-keyword'>case</span> <span class='hs-varid'>join</span> <span class='hs-varop'>$</span> <span class='hs-varid'>relation</span> <span class='hs-varop'>`fmap`</span> <span class='hs-varid'>maybeObject</span> <span class='hs-keyword'>of</span>
<a name="line-1356"></a>            <span class='hs-conid'>Just</span> <span class='hs-varid'>oid</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>checkRecurrence'</span> <span class='hs-varid'>oid</span>
<a name="line-1357"></a>            <span class='hs-conid'>Nothing</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-1358"></a>
<a name="line-1359"></a><a name="binaryString"></a><span class='hs-comment'>-- | Translate a MOO /binary string/ into a Haskell 'ByteString', raising</span>
<a name="line-1360"></a><span class='hs-comment'>-- 'E_INVARG' if the MOO string is improperly formatted.</span>
<a name="line-1361"></a><span class='hs-definition'>binaryString</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>ByteString</span>
<a name="line-1362"></a><span class='hs-definition'>binaryString</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>maybe</span> <span class='hs-layout'>(</span><span class='hs-varid'>raise</span> <span class='hs-conid'>E_INVARG</span><span class='hs-layout'>)</span> <span class='hs-varid'>return</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>toBinary</span>
<a name="line-1363"></a>
<a name="line-1364"></a><a name="random"></a><span class='hs-comment'>-- | Generate and return a pseudorandom number in the given range, modifying</span>
<a name="line-1365"></a><span class='hs-comment'>-- the local generator state.</span>
<a name="line-1366"></a><span class='hs-definition'>random</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Random</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-varid'>a</span>
<a name="line-1367"></a><span class='hs-definition'>random</span> <span class='hs-varid'>range</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1368"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>r</span><span class='hs-layout'>,</span> <span class='hs-varid'>gen</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>randomR</span> <span class='hs-varid'>range</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>randomGen</span>
<a name="line-1369"></a>  <span class='hs-varid'>modify</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>randomGen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gen</span> <span class='hs-layout'>}</span>
<a name="line-1370"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>r</span>
<a name="line-1371"></a>
<a name="line-1372"></a><a name="newRandomGen"></a><span class='hs-comment'>-- | Split the local random number generator state in two, updating the local</span>
<a name="line-1373"></a><span class='hs-comment'>-- state with one of them and returning the other.</span>
<a name="line-1374"></a><span class='hs-definition'>newRandomGen</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>StdGen</span>
<a name="line-1375"></a><span class='hs-definition'>newRandomGen</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1376"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>gen</span><span class='hs-layout'>,</span> <span class='hs-varid'>gen'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>split</span> <span class='hs-varop'>`liftM`</span> <span class='hs-varid'>gets</span> <span class='hs-varid'>randomGen</span>
<a name="line-1377"></a>  <span class='hs-varid'>modify</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>state</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>state</span> <span class='hs-layout'>{</span> <span class='hs-varid'>randomGen</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>gen</span> <span class='hs-layout'>}</span>
<a name="line-1378"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>gen'</span>
<a name="line-1379"></a>
<a name="line-1380"></a><a name="formatTraceback"></a><span class='hs-comment'>-- | Generate traceback lines for an exception, suitable for displaying to a</span>
<a name="line-1381"></a><span class='hs-comment'>-- user.</span>
<a name="line-1382"></a><span class='hs-definition'>formatTraceback</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Exception</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StrT</span><span class='hs-keyglyph'>]</span>
<a name="line-1383"></a><span class='hs-definition'>formatTraceback</span> <span class='hs-varid'>except</span><span class='hs-keyglyph'>@</span><span class='hs-conid'>Exception</span> <span class='hs-layout'>{</span> <span class='hs-varid'>exceptionCallStack</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Stack</span> <span class='hs-varid'>frames</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-1384"></a>  <span class='hs-varid'>map</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>fromText</span> <span class='hs-varop'>$</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>splitOn</span> <span class='hs-str'>"\n"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>execWriter</span> <span class='hs-layout'>(</span><span class='hs-varid'>traceback</span> <span class='hs-varid'>frames</span><span class='hs-layout'>)</span>
<a name="line-1385"></a>
<a name="line-1386"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>traceback</span> <span class='hs-layout'>(</span><span class='hs-varid'>frame</span><span class='hs-conop'>:</span><span class='hs-varid'>frames</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1387"></a>          <span class='hs-varid'>describeVerb</span> <span class='hs-varid'>frame</span>
<a name="line-1388"></a>          <span class='hs-varid'>tell</span> <span class='hs-varop'>$</span> <span class='hs-str'>":  "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>toText</span> <span class='hs-layout'>(</span><span class='hs-varid'>exceptionMessage</span> <span class='hs-varid'>except</span><span class='hs-layout'>)</span>
<a name="line-1389"></a>          <span class='hs-varid'>traceback'</span> <span class='hs-varid'>frames</span>
<a name="line-1390"></a>        <span class='hs-varid'>traceback</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceback'</span> <span class='hs-conid'>[]</span>
<a name="line-1391"></a>
<a name="line-1392"></a>        <span class='hs-varid'>traceback'</span> <span class='hs-layout'>(</span><span class='hs-varid'>frame</span><span class='hs-conop'>:</span><span class='hs-varid'>frames</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1393"></a>          <span class='hs-varid'>tell</span> <span class='hs-str'>"\n... called from "</span>
<a name="line-1394"></a>          <span class='hs-varid'>describeVerb</span> <span class='hs-varid'>frame</span>
<a name="line-1395"></a>          <span class='hs-varid'>traceback'</span> <span class='hs-varid'>frames</span>
<a name="line-1396"></a>        <span class='hs-varid'>traceback'</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tell</span> <span class='hs-str'>"\n(End of traceback)"</span>
<a name="line-1397"></a>
<a name="line-1398"></a>        <span class='hs-varid'>describeVerb</span> <span class='hs-conid'>Frame</span> <span class='hs-layout'>{</span> <span class='hs-varid'>builtinFunc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-1399"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>verbLocation</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>verbFullName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span>
<a name="line-1400"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>initialThis</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>this</span><span class='hs-layout'>,</span> <span class='hs-varid'>lineNumber</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>line</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1401"></a>          <span class='hs-varid'>tell</span> <span class='hs-varop'>$</span> <span class='hs-str'>"#"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-str'>":"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>toText</span> <span class='hs-varid'>name</span>
<a name="line-1402"></a>          <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span> <span class='hs-varop'>/=</span> <span class='hs-varid'>this</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tell</span> <span class='hs-varop'>$</span> <span class='hs-str'>" (this == #"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>this</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-str'>")"</span>
<a name="line-1403"></a>          <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>line</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tell</span> <span class='hs-varop'>$</span> <span class='hs-str'>", line "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>pack</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>line</span><span class='hs-layout'>)</span>
<a name="line-1404"></a>        <span class='hs-varid'>describeVerb</span> <span class='hs-conid'>Frame</span> <span class='hs-layout'>{</span> <span class='hs-varid'>builtinFunc</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>verbName</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>name</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>=</span>
<a name="line-1405"></a>          <span class='hs-varid'>tell</span> <span class='hs-varop'>$</span> <span class='hs-str'>"built-in function "</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>toText</span> <span class='hs-varid'>name</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-str'>"()"</span>
<a name="line-1406"></a>
<a name="line-1407"></a><a name="shutdown"></a><span class='hs-comment'>-- | Begin the server shutdown process.</span>
<a name="line-1408"></a><span class='hs-definition'>shutdown</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StrT</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>MOO</span> <span class='hs-conid'>()</span>
<a name="line-1409"></a><span class='hs-definition'>shutdown</span> <span class='hs-varid'>message</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-1410"></a>  <span class='hs-varid'>world</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getWorld</span>
<a name="line-1411"></a>  <span class='hs-varid'>mapM_</span> <span class='hs-varid'>unlisten</span> <span class='hs-layout'>(</span><span class='hs-conid'>M</span><span class='hs-varop'>.</span><span class='hs-varid'>keys</span> <span class='hs-varop'>$</span> <span class='hs-varid'>listeners</span> <span class='hs-varid'>world</span><span class='hs-layout'>)</span>
<a name="line-1412"></a>  <span class='hs-varid'>delayIO</span> <span class='hs-varop'>$</span> <span class='hs-varid'>void</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tryPutMVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>shutdownMessage</span> <span class='hs-varid'>world</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Str</span><span class='hs-varop'>.</span><span class='hs-varid'>toText</span> <span class='hs-varid'>message</span><span class='hs-layout'>)</span>
</pre></body>
</html>
